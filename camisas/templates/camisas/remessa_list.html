<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Camisas • Remessas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --ring:rgba(37,99,235,.18); --g1:#f30c80; --g2:#f30c80; --base-font:14px; }
    html{ font-size:var(--base-font); }
    body{ background:#f6f8fb; color:var(--ink); }

    .nav-pro{ background:linear-gradient(90deg,var(--g1),var(--g2)); }
    .card-clean{ border:none; border-radius:.9rem; box-shadow:0 10px 24px rgba(17,24,39,.08); }
    .mini{ font-size:.8rem; color:var(--muted); }
    .badge-soft{ background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }

    .toolbar .form-control, .toolbar .form-select{ border-radius:.65rem; }
    .form-control:focus, .form-select:focus{ box-shadow:0 0 0 .25rem var(--ring); border-color:#93c5fd; }

    .table{ font-size:.875rem; }
    .table thead th{ font-size:.78rem; text-transform:uppercase; letter-spacing:.04em; color:#64748b; border-top:0; }
  </style>
</head>
<body>

<nav class="navbar nav-pro navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{% url 'camisas:home' %}">YLA Criativa • Camisas</a>
    <div class="ms-auto d-flex flex-wrap gap-2">
      <a class="btn btn-sm btn-light" href="{% url 'camisas:empresa_list' %}">Empresas</a>
      <a class="btn btn-sm btn-light" href="{% url 'camisas:cliente_list' %}">Clientes</a>
      <a class="btn btn-sm btn-light" href="{% url 'camisas:insumo_list' %}">Insumos</a>
      <a class="btn btn-sm btn-light" href="{% url 'camisas:produto_list' %}">Produtos</a>
      <a class="btn btn-sm btn-light" href="{% url 'camisas:remessa_list' %}">Remessas</a>
      <a class="btn btn-sm btn-success" href="{% url 'camisas:remessa_create' %}">+ Nova remessa</a>
      <a class="btn btn-sm btn-warning" href="{% url 'camisas:op_create' %}">Ordem Produção</a>
      <a class="btn btn-sm btn-info" href="{% url 'camisas:pedido_list' %}">Pedidos</a>
    </div>
  </div>
</nav>

<main class="container py-4">

  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}

  <!-- Filtros -->
  <div class="card-clean p-3 toolbar mb-3">
    <form class="row g-2 align-items-end" method="get">
      <div class="col-12 col-md-3">
        <label class="form-label mini">Buscar</label>
        <input class="form-control" name="q" value="{{ sel.q }}" placeholder="Número ou costureira">
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label mini">Empresa</label>
        <select class="form-select" name="empresa">
          <option value="">Todas</option>
          {% for e in empresas %}
            <option value="{{ e.id }}" {% if sel.empresa == e.id|stringformat:"s" %}selected{% endif %}>{{ e.nome_fantasia }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label mini">Tipo</label>
        <select class="form-select" name="tipo">
          <option value="">Todos</option>
          <option value="CORTE" {% if sel.tipo == 'CORTE' %}selected{% endif %}>Corte</option>
          <option value="COSTURA" {% if sel.tipo == 'COSTURA' %}selected{% endif %}>Costura</option>
          <option value="CORRECAO" {% if sel.tipo == 'CORRECAO' %}selected{% endif %}>Correção</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label mini">Status</label>
        <select class="form-select" name="status">
          <option value="">Todos</option>
          <option value="ENVIADA" {% if sel.status == 'ENVIADA' %}selected{% endif %}>Enviada</option>
          <option value="PARCIAL" {% if sel.status == 'PARCIAL' %}selected{% endif %}>Parcial</option>
          <option value="CONCLUIDO" {% if sel.status == 'CONCLUIDO' %}selected{% endif %}>Concluído</option>
          <option value="CANCELADA" {% if sel.status == 'CANCELADA' %}selected{% endif %}>Cancelada</option>
        </select>
      </div>
      <div class="col-6 col-md-1 d-grid">
        <button class="btn btn-primary">Filtrar</button>
      </div>
      <div class="col-6 col-md-1 d-grid">
        <a class="btn btn-outline-secondary" href="{% url 'camisas:remessa_list' %}">Limpar</a>
      </div>
    </form>
  </div>

  <!-- Tabela -->
  <div class="card-clean p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0">Remessas</h2>
      <div class="d-flex gap-2">
        <button id="btnExportRemessas" class="btn btn-dark btn-sm">Exportar CSV</button>
        <a class="btn btn-sm btn-success" href="{% url 'camisas:remessa_create' %}">+ Nova remessa</a>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th>#</th><th>Empresa</th><th>Costureira</th><th>Tipo</th><th>Status</th>
            <th>Enviado</th><th>Recebido</th><th>Kg</th><th></th>
          </tr>
        </thead>
        <tbody id="tblBodyRemessas">
          {% for r in rows %}
          <tr>
            <td class="fw-semibold">{{ r.numero }}</td>
            <td>{{ r.empresa.nome_fantasia }}</td>
            <td>{{ r.costureira.nome }}</td>
            <td>{{ r.get_tipo_display }}</td>
            <td>
              <span class="badge {% if r.status == 'CONCLUIDO' %}text-bg-success{% elif r.status == 'PARCIAL' %}text-bg-warning{% elif r.status == 'CANCELADA' %}text-bg-danger{% else %}text-bg-secondary{% endif %}">{{ r.get_status_display }}</span>
            </td>
            <td class="mini">{{ r.enviado_em|date:"d/m/Y H:i" }}</td>
            <td class="mini">{% if r.recebido_em %}{{ r.recebido_em|date:"d/m/Y H:i" }}{% else %}—{% endif %}</td>
            <td>{{ r.kg_enviados|floatformat:3 }}</td>
            <td class="text-end">
              <div class="btn-group">
                <a class="btn btn-sm btn-outline-primary" href="{% url 'camisas:remessa_detail' r.id %}">Abrir</a>
                <a class="btn btn-sm btn-outline-secondary" target="_blank" href="{% url 'camisas:remessa_print' r.id %}">Imprimir</a>
                {% if not r.recebido_em %}
                  <a class="btn btn-sm btn-success" href="{% url 'camisas:remessa_receive' r.id %}">Receber</a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="9" class="text-center text-muted py-4">Sem remessas.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if page_obj %}
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="mini">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</div>
        <nav>
          <ul class="pagination pagination-sm mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ sel.q }}&empresa={{ sel.empresa }}&tipo={{ sel.tipo }}&status={{ sel.status }}">Anterior</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Anterior</span></li>
            {% endif %}
            <li class="page-item active"><span class="page-link">{{ page_obj.number }}</span></li>
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ sel.q }}&empresa={{ sel.empresa }}&tipo={{ sel.tipo }}&status={{ sel.status }}">Próxima</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Próxima</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}
  </div>
</main>

<script>
(function(){
  const btn = document.getElementById('btnExportRemessas');
  btn && btn.addEventListener('click', ()=>{
    const body = document.getElementById('tblBodyRemessas');
    if(!body){ alert('Sem dados'); return; }
    const rows = Array.from(body.querySelectorAll('tr'));
    if(!rows.length){ alert('Sem dados'); return; }
    const head = ['Numero','Empresa','Costureira','Tipo','Status','Enviado','Recebido','Kg'];
    const data = rows.map(r=>{
      const tds = Array.from(r.children);
      return [
        tds[0].innerText,
        tds[1].innerText,
        tds[2].innerText,
        tds[3].innerText,
        tds[4].innerText.trim(),
        tds[5].innerText,
        tds[6].innerText,
        tds[7].innerText
      ];
    });
    const csv = [head, ...data].map(row=> row.map(c=> '"'+(c||'').replace(/"/g,'""')+'"').join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='remessas.csv';
    document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 1200);
  });
})();
</script>

</body>
</html>
