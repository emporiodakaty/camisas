<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Informar tamanhos — Pedido #{{ pedido.pk }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --g1:#f30c80; --g2:#f30c80; --base:14px; }
    html{font-size:var(--base)} body{background:#f6f8fb;color:var(--ink)}
    .paper{max-width:920px;margin:18px auto;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 24px rgba(17,24,39,.08)}
    .brand{background:linear-gradient(90deg,var(--g1),var(--g2));color:#fff;border-radius:12px 12px 0 0;padding:10px 14px}
    .p-wrap{padding:16px}
    .mini{font-size:.85rem;color:var(--muted)}
    .table thead th{font-size:.78rem;text-transform:uppercase;letter-spacing:.04em;color:#64748b;border-top:0}
    .badge-soft{background:#eef2f7;color:#334155}
    .form-control,.form-select{border-radius:.6rem}
  </style>
</head>
<body>
<div class="paper">
  <div class="brand d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
      {% if empresa and empresa.logo_has_file and empresa.logo_url_safe %}
        <img src="{{ empresa.logo_url_safe }}" alt="Logo" style="height:34px;object-fit:contain">
      {% endif %}
      <div>
        <div class="fw-bold">Informar tamanhos</div>
        <div class="text-white-50 small">Pedido #{{ pedido.pk }} • {{ pedido.criado_em|date:"d/m/Y" }}</div>
      </div>
    </div>
    {% if pedido.arte_has_file %}
      <span class="badge badge-soft">Arte anexada</span>
    {% endif %}
  </div>

  <div class="p-wrap">
    {% for m in messages %}<div class="alert alert-{{ m.tags }}">{{ m }}</div>{% endfor %}

    <form method="post" id="formColeta" class="needs-validation" novalidate>
      {% csrf_token %}

      <!-- Dados do responsável -->
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Seu nome</label>
          <input name="nome" type="text" class="form-control" value="{{ coleta.cliente_nome|default:cliente.nome|default:'' }}" required>
          <div class="invalid-feedback">Informe seu nome.</div>
        </div>
        <div class="col-md-6">
          <label class="form-label">E-mail</label>
          <input name="email" type="email" class="form-control" value="{{ coleta.cliente_email|default:cliente.email|default:'' }}">
        </div>
        <div class="col-12">
          <label class="form-label">Observações</label>
          <textarea name="obs" class="form-control" rows="2" placeholder="Ex.: nome na manga, patch, fonte, etc.">{{ coleta.obs_cliente|default:'' }}</textarea>
        </div>
      </div>

      <hr class="my-3">

      {# ===================== MODO: SIMPLES (select Tamanho + input Quantidade) ===================== #}
      {% if coleta.modo == 'SIMPLES' %}
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h6 m-0">Quantidades por tamanho</h2>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="addRowSimples()">+ Adicionar linha</button>
        </div>

        <div class="table-responsive">
          <table id="tblSimples" class="table align-middle">
            <thead>
              <tr>
                <th style="width:55%">Tamanho</th>
                <th style="width:25%">Quantidade</th>
                <th style="width:20%"></th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr class="small">
                <td colspan="3" class="text-end">
                  <span class="mini me-3">Total de peças:</span>
                  <strong id="totalSimplesSpan">0</strong>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- onde os inputs ocultos q_<TAM> serão injetados antes de enviar -->
        <div id="hiddenInputsSimples"></div>

      {# ===================== MODO: NOMES ===================== #}
      {% elif coleta.modo == 'NOMES' %}
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h6 m-0">Tamanhos + nomes</h2>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="addRowNomes()">+ Adicionar</button>
        </div>

        <div class="table-responsive">
          <table id="tblNomes" class="table align-middle">
            <thead>
              <tr>
                <th style="width:55%">Nome</th>
                <th style="width:35%">Tamanho</th>
                <th style="width:10%"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      {# ===================== MODO: TIME ===================== #}
      {% else %}
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h6 m-0">Time (nome + número + tamanho + quantidade + short)</h2>
          <button class="btn btn-outline-primary btn-sm" type="button" onclick="addRowTime()">+ Adicionar jogador</button>
        </div>

        <div class="table-responsive">
          <table id="tblTime" class="table align-middle">
            <thead>
              <tr>
                <th style="width:24%">Nome</th>
                <th style="width:10%">Número</th>
                <th style="width:18%">Tamanho</th>
                <th style="width:10%">Qtd</th>
                <th style="width:10%">Short?</th>
                <th style="width:18%">Tam. Short</th>
                <th style="width:10%"></th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr class="small">
                <td colspan="7" class="text-end">
                  <span class="mini me-3">Total de peças:</span>
                  <strong id="totalTime">0</strong>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      {% endif %}

      <div class="d-flex justify-content-end gap-2 mt-3">
        <button class="btn btn-primary">Enviar</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ------------ opções de tamanhos ------------- */
const TAMANHOS_BACK = [{% for t in tamanhos %}"{{ t }}"{% if not forloop.last %},{% endif %}{% endfor %}] || [];
const BL = ["PP-BL","P-BL","M-BL","G-BL","GG-BL","XG-BL"];
const CAMISA = Array.from(new Set([...(TAMANHOS_BACK.length ? TAMANHOS_BACK : ["PP","P","M","G","GG","XG"]), ...BL]));
const SHORTS = ["","P","M","G","GG"];
function optionHtml(list, sel){ return list.map(v=>`<option value="${v}"${v===sel?' selected':''}>${v||'—'}</option>`).join(''); }

/* ================== SIMPLES: linha Tamanho + Quantidade ================== */
function addRowSimples(prefill={}){
  const tbody = document.querySelector('#tblSimples tbody');
  const tr = document.createElement('tr');
  const defaultSize = (prefill.size && CAMISA.includes(prefill.size)) ? prefill.size : (CAMISA[0] || "");
  const defaultQty  = Number.isFinite(parseInt(prefill.qty,10)) && parseInt(prefill.qty,10) > 0 ? parseInt(prefill.qty,10) : 1;

  tr.innerHTML = `
    <td>
      <select name="sizes_simple[]" class="form-select" required>
        ${optionHtml(CAMISA, defaultSize)}
      </select>
    </td>
    <td style="max-width:140px">
      <input name="qtys_simple[]" type="number" min="1" step="1"
             class="form-control qty-simples" value="${defaultQty}" required>
    </td>
    <td class="text-end">
      <button type="button" class="btn btn-sm btn-outline-danger"
              onclick="this.closest('tr').remove(); recalcTotalSimples();">Remover</button>
    </td>
  `;
  tbody.appendChild(tr);
  tr.querySelector('.qty-simples')?.addEventListener('input', recalcTotalSimples);
  recalcTotalSimples();
}

function recalcTotalSimples(){
  let tot = 0;
  document.querySelectorAll('.qty-simples').forEach(i=>{
    const n = parseInt(i.value||'0',10);
    if(!isNaN(n) && n > 0) tot += n;
  });
  const el = document.getElementById('totalSimplesSpan'); if(el) el.textContent = tot;
}

/* ================== NOMES ================== */
function addRowNomes(prefill={}){
  const tbody = document.querySelector('#tblNomes tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input name="names[]" class="form-control" placeholder="Nome" value="${(prefill.name||'').replace(/"/g,'&quot;')}"></td>
    <td>
      <select name="sizes[]" class="form-select">${optionHtml(CAMISA, prefill.size||"")}</select>
    </td>
    <td class="text-end">
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">Remover</button>
    </td>
  `;
  tbody.appendChild(tr);
}

/* ================== TIME ================== */
function addRowTime(prefill={}){
  const tbody = document.querySelector('#tblTime tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input name="names[]" class="form-control" placeholder="Nome" value="${(prefill.name||'').replace(/"/g,'&quot;')}"></td>
    <td style="max-width:110px"><input name="numbers[]" class="form-control" placeholder="00" value="${(prefill.number||'').replace(/"/g,'&quot;')}"></td>
    <td><select name="sizes[]" class="form-select">${optionHtml(CAMISA, prefill.size||"")}</select></td>
    <td style="max-width:110px"><input name="qtys[]" type="number" min="1" step="1" class="form-control qty-time" value="${parseInt(prefill.qty||1,10)}"></td>
    <td class="text-center" style="max-width:90px"><input name="shorts[]" type="checkbox" class="form-check-input short-flag" ${prefill.short ? "checked": ""}></td>
    <td><select name="short_sizes[]" class="form-select short-size" ${prefill.short ? "" : "disabled"}>${optionHtml(SHORTS, prefill.short_size||"")}</select></td>
    <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRowTime(this)">Remover</button></td>
  `;
  tbody.appendChild(tr);
  bindTimeRow(tr);
  recalcTotalTime();
}
function removeRowTime(btn){ btn.closest('tr')?.remove(); recalcTotalTime(); }
function bindTimeRow(tr){
  tr.querySelector('.qty-time')?.addEventListener('input', recalcTotalTime);
  const flag = tr.querySelector('.short-flag');
  const sel  = tr.querySelector('.short-size');
  if(flag && sel){
    flag.addEventListener('change', ()=>{
      sel.disabled = !flag.checked;
      if(!flag.checked) sel.value = "";
    });
  }
}
function recalcTotalTime(){
  let tot = 0;
  document.querySelectorAll('.qty-time').forEach(i=>{
    const n = parseInt(i.value||'0',10); if(!isNaN(n)) tot += n;
  });
  const el = document.getElementById('totalTime'); if(el) el.textContent = tot;
}

/* ---------- validação por modo + linhas iniciais + agregação SIMPLES ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  const modo = "{{ coleta.modo }}";

  // inicia com 1 linha pronta conforme modo
  if(modo === "SIMPLES"){
    if(document.querySelectorAll('#tblSimples tbody tr').length === 0){ addRowSimples(); }
  } else if(modo === "NOMES"){
    if(document.querySelectorAll('#tblNomes tbody tr').length === 0){ addRowNomes(); }
  } else if(modo === "TIME"){
    if(document.querySelectorAll('#tblTime tbody tr').length === 0){ addRowTime(); }
  }

  const form = document.getElementById('formColeta');
  if(!form) return;

  form.addEventListener('submit', function(e){
    // nome obrigatório
    const nome = form.querySelector('input[name="nome"]');
    if(nome && !nome.value.trim()){
      e.preventDefault(); form.classList.add('was-validated'); return;
    }

    if(modo === "SIMPLES"){
      // agrega linhas em q_<TAM> para o backend
      const rows = Array.from(document.querySelectorAll('#tblSimples tbody tr'));
      const acc = {}; // {TAM: total}
      rows.forEach(r=>{
        const size = (r.querySelector('select[name="sizes_simple[]"]')?.value||"").trim();
        const q = parseInt(r.querySelector('input[name="qtys_simple[]"]')?.value||'0',10);
        if(size && q>0){
          acc[size] = (acc[size]||0) + q;
        }
      });

      // pelo menos 1 válido
      const total = Object.values(acc).reduce((a,b)=>a+b,0);
      if(total <= 0){
        e.preventDefault();
        alert('Informe ao menos uma linha com Tamanho e Quantidade maior que zero.');
        return;
      }

      // recria inputs ocultos q_<TAM>
      const holder = document.getElementById('hiddenInputsSimples');
      holder.innerHTML = "";
      Object.entries(acc).forEach(([size, qty])=>{
        const inp = document.createElement('input');
        inp.type = 'hidden';
        inp.name = `q_${size}`; // aceita hífen (ex.: PP-BL)
        inp.value = String(qty);
        holder.appendChild(inp);
      });
    }
    else if(modo === "NOMES"){
      const rows = Array.from(document.querySelectorAll('#tblNomes tbody tr'));
      const ok = rows.some(r=>{
        const n = (r.querySelector('input[name="names[]"]')?.value||'').trim();
        const s = (r.querySelector('select[name="sizes[]"]')?.value||'').trim();
        return n && s;
      });
      if(!ok){
        e.preventDefault();
        alert('Adicione ao menos uma linha com Nome e Tamanho.');
        return;
      }
    }
    else { // TIME
      const rows = Array.from(document.querySelectorAll('#tblTime tbody tr'));
      const ok = rows.some(r=>{
        const n  = (r.querySelector('input[name="names[]"]')?.value||'').trim();
        const s  = (r.querySelector('select[name="sizes[]"]')?.value||'').trim();
        const q  = parseInt(r.querySelector('input[name="qtys[]"]')?.value||'0',10);
        return n && s && q>=1;
      });
      if(!ok){
        e.preventDefault();
        alert('Adicione ao menos uma linha com Nome, Tamanho e Quantidade (>=1).');
        return;
      }
    }
  });
});
</script>

</body>
</html>
