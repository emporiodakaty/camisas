<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Aprova√ß√£o de ARTE ‚Ä¢ Pedido #{{ pedido.pk }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --g1:#000; --g2:#000; --base:14px;
    }
    html{font-size:var(--base)}
    body{background:#f6f8fb;color:var(--ink)}
    .paper{max-width:960px;margin:24px auto;background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 24px rgba(17,24,39,.08)}
    .brand{background:linear-gradient(90deg,var(--g1),var(--g2));color:#fff;border-top-left-radius:12px;border-top-right-radius:12px;padding:12px 16px}
    .brand .logo{max-height:28px;width:auto;object-fit:contain;border-radius:6px;background:#fff;padding:2px}
    .brand .name{font-weight:700}
    .brand .sub{color:rgba(255,255,255,.8)}
    .p-wrap{padding:22px}
    .small-muted{color:var(--muted)}
    .arte-box{border:1px dashed #cbd5e1;border-radius:10px;padding:14px;background:#fafbff}
    .sig-img{max-height:90px;width:auto;object-fit:contain}
    .mini-head{font-size:.78rem;text-transform:uppercase;letter-spacing:.04em;color:#64748b;margin-bottom:.25rem}
    .box{border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fff}

    /* tabelas de dados */
    .info{width:100%;border-collapse:collapse}
    .info th{white-space:nowrap;color:#64748b;font-weight:600;padding:.2rem .3rem;vertical-align:top}
    .info td{padding:.2rem .3rem}

    /* üëá menor fonte s√≥ para Empresa/Cliente */
    .info--compact{font-size:.88rem}
    .info--compact th,.info--compact td{padding:.16rem .26rem}

    /* Empresa √ó Cliente lado a lado tamb√©m na impress√£o, sem quebra */
    .ec-row{}
    @media print{
      .no-print{display:none!important}
      .paper{box-shadow:none;border:0;margin:0}
      .brand{padding:8px 12px}
      .p-wrap{padding:16px}
      .ec-row{
        display:grid !important;
        grid-template-columns: 1fr 1fr !important;
        column-gap: 14px !important;
        align-items:start;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .ec-row .col,
      .ec-row .box{
        page-break-inside: avoid;
        break-inside: avoid;
      }
      /* ainda mais compacto na impress√£o */
      .info--compact{font-size:.8rem}
      .info--compact th,.info--compact td{padding:.12rem .22rem}
    }

    /* Modal de assinatura */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:1000}
    .overlay[aria-hidden="false"]{display:block}
    .modal-card{max-width:640px;margin:5vh auto;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.2)}
    .modal-head{padding:16px 20px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
    .modal-body{padding:16px 20px}
    .btn-icon{border:0;background:transparent;font-size:22px;line-height:1;cursor:pointer}
  </style>
</head>
<body>
<div class="paper">
  <!-- TOPO: Logo + Nome da Empresa + T√≠tulo -->
  <div class="brand d-flex justify-content-between align-items-center gap-3">
    <div class="d-flex align-items-center gap-2">
      {% if empresa and empresa.logo_has_file %}
        <img class="logo" src="{{ empresa.logo_url_safe }}" alt="Logo {{ empresa.nome_fantasia|default:empresa.razao_social }}">
      {% endif %}
      <div>
        <div class="name">
          {{ empresa.nome_fantasia|default:empresa.razao_social|default:"" }}
        </div>
        <div class="sub small">Aprova√ß√£o de ARTE</div>
      </div>
    </div>
    <div class="text-end">
      <div class="text-white-50 small">
        Pedido #{{ pedido.pk }} ‚Ä¢ {{ pedido.criado_em|date:"d/m/Y H:i" }}
      </div>
      <button class="btn btn-light btn-sm no-print mt-1" onclick="window.print()">Imprimir</button>
    </div>
  </div>

  <div class="p-wrap">
    {% if feedback %}<div class="alert alert-success">{{ feedback }}</div>{% endif %}

    <!-- Empresa / Cliente em TABELAS (lado a lado; sem quebra na impress√£o) -->
    <div class="row g-3 mb-3 ec-row">
      <div class="col">
        <div class="mini-head">Empresa</div>
        <div class="box">
          <table class="info info--compact">
            <tr>
              <th>Nome</th>
              <td>{{ empresa.nome_fantasia|default:empresa.razao_social|default:"‚Äî" }}</td>
            </tr>
            {% if empresa.cnpj %}
            <tr><th>CNPJ</th><td>{{ empresa.cnpj }}</td></tr>
            {% endif %}
            {% if empresa.ie %}
            <tr><th>IE</th><td>{{ empresa.ie }}</td></tr>
            {% endif %}
            {% if empresa.email %}
            <tr><th>E-mail</th><td>{{ empresa.email }}</td></tr>
            {% endif %}
            {% if empresa.telefone %}
            <tr><th>Telefone</th><td>{{ empresa.telefone }}</td></tr>
            {% endif %}
            {% if empresa.endereco or empresa.cidade or empresa.uf %}
            <tr>
              <th>Endere√ßo</th>
              <td>
                {{ empresa.endereco|default:"" }}
                {% if empresa.cidade %}{% if empresa.endereco %} ‚Äî {% endif %}{{ empresa.cidade }}{% endif %}
                {% if empresa.uf %}{% if empresa.cidade %}/{% endif %}{{ empresa.uf }}{% endif %}
              </td>
            </tr>
            {% endif %}
          </table>
        </div>
      </div>

      <div class="col">
        <div class="mini-head">Cliente</div>
        <div class="box">
          <table class="info info--compact">
            <tr><th>Nome</th><td>{{ cliente }}</td></tr>
            {% if cliente.cpf_cnpj %}<tr><th>CPF/CNPJ</th><td>{{ cliente.cpf_cnpj }}</td></tr>{% endif %}
            {% if cliente.email %}<tr><th>E-mail</th><td>{{ cliente.email }}</td></tr>{% endif %}
            {% if cliente.telefone %}<tr><th>Telefone</th><td>{{ cliente.telefone }}</td></tr>{% endif %}
          </table>
        </div>
      </div>
    </div>

    <!-- Arte -->
    <div class="mb-3">
      <h3 class="h6 mb-2">Pr√©via da arte</h3>
      {% if pedido.arte and pedido.arte.name %}
        <div class="arte-box text-center">
          <img src="{{ pedido.arte.url }}" alt="Arte do pedido" style="max-width:100%;height:auto">
        </div>
      {% else %}
        <div class="arte-box text-center small-muted">Nenhuma arte anexada a este pedido.</div>
      {% endif %}
    </div>

    <!-- Aviso sobre varia√ß√£o de cor por dispositivo -->
    <div class="small small-muted">
      <strong>Aviso sobre cores:</strong> a apar√™ncia das cores pode variar conforme o dispositivo (celular, tablet ou monitor),
      configura√ß√µes de brilho/contraste, recursos como <em>True Tone/Night Shift/Modo V√≠vido</em> e perfis de cor. Telas exibem em
      RGB, enquanto processos de estamparia/serigrafia usam tintas (CMYK/Pantone). Pequenas diferen√ßas entre a visualiza√ß√£o e o
      produto final s√£o normais. Para melhor refer√™ncia, recomenda-se revisar em monitor calibrado, com brilho em torno de 50‚Äì70%.
    </div>

    <!-- Termos curtos -->
    <div class="small small-muted mt-2">
      Confirme se a arte est√° correta (cores, tamanhos, posicionamento e ortografia).
      Ao <strong>aprovar</strong>, a produ√ß√£o poder√° ser iniciada e eventuais altera√ß√µes podem gerar novo prazo e custo.
    </div>

    <!-- Assinatura exibida (se j√° houver) -->
    {% if pedido.artwork_signature and pedido.artwork_signature.name %}
      <div class="mt-3">
        <div class="small text-uppercase mb-1">Assinatura registrada</div>
        <div class="arte-box text-center">
          <img class="sig-img" src="{{ pedido.artwork_signature.url }}" alt="Assinatura">
          <div class="small-muted mt-2">
            {{ pedido.artwork_name|default:"‚Äî" }} ‚Ä¢ {{ pedido.artwork_decided_at|date:"d/m/Y H:i" }}
          </div>
        </div>
      </div>
    {% endif %}

    <!-- Form de decis√£o (apenas se pendente) -->
    {% if pedido.artwork_status == 'PEND' %}
      <form id="formDecisao" method="post" class="no-print mt-4">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Seu nome</label>
            <input name="name" id="name" type="text" class="form-control" placeholder="Quem est√° aprovando?">
          </div>
          <div class="col-md-4">
            <label class="form-label">E-mail</label>
            <input name="email" type="email" class="form-control" placeholder="Opcional">
          </div>
          <div class="col-12">
            <label class="form-label">Coment√°rio</label>
            <textarea name="comment" class="form-control" rows="3" placeholder="Observa√ß√µes (opcional)"></textarea>
          </div>
        </div>

        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="ack_terms" name="ack_terms" required>
          <label class="form-check-label small" for="ack_terms">
            Declaro que revisei a arte e estou ciente das condi√ß√µes acima.
          </label>
        </div>

        <input type="hidden" name="decision" id="decisionField" value="">
        <input type="hidden" name="signature_png" id="signature_png">
        <input type="hidden" name="tz" id="tz">
        <input type="hidden" name="ua" id="ua">

        <div class="d-flex gap-2 mt-3">
          <button type="button" id="btnOpenSignature" class="btn btn-success">‚úÖ Aprovar arte</button>
          <button class="btn btn-outline-danger" name="decision" value="reject">üö´ Recusar</button>
          <button type="button" class="btn btn-light" onclick="window.print()">Imprimir</button>
        </div>
      </form>
    {% else %}
      <div class="d-flex align-items-center gap-2 mt-3 no-print">
        <span class="badge {% if pedido.artwork_status == 'APRV' %}text-bg-success{% elif pedido.artwork_status == 'REJ' %}text-bg-danger{% else %}text-bg-secondary{% endif %}">
          {{ pedido.get_artwork_status_display|default:pedido.artwork_status }}
        </span>
        <button class="btn btn-light" onclick="window.print()">Imprimir</button>
      </div>
    {% endif %}
  </div>
</div>

<!-- Modal Assinatura -->
<div id="signatureOverlay" class="overlay" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="assTitle">
    <div class="modal-head">
      <h2 id="assTitle" class="h5 m-0">Assinar aprova√ß√£o de ARTE</h2>
      <button id="btnCloseSignature" class="btn-icon" aria-label="Fechar">√ó</button>
    </div>
    <div class="modal-body">
      <p class="mb-2">Assine no quadro abaixo e confirme o aceite dos termos.</p>
      <div class="border rounded-3 p-2 bg-light">
        <canvas id="sigCanvas" style="width:100%;height:220px;display:block;background:#fff;border-radius:8px"></canvas>
        <div class="d-flex align-items-center gap-2 mt-2">
          <button type="button" id="btnClear" class="btn btn-sm btn-outline-secondary">Limpar</button>
          <small id="sigHint" class="text-danger d-none">Desenhe sua assinatura antes de confirmar.</small>
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label">Nome completo (para constar no termo)</label>
        <input id="signerName" type="text" class="form-control" placeholder="Digite seu nome">
      </div>
      <div class="form-check mt-3">
        <input class="form-check-input" type="checkbox" id="acceptTerms">
        <label class="form-check-label" for="acceptTerms">Li e concordo com os termos e autorizo o uso desta assinatura eletr√¥nica.</label>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <button type="button" id="btnCancel" class="btn btn-light">Cancelar</button>
        <button type="button" id="btnConfirm" class="btn btn-primary">Confirmar aprova√ß√£o</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>
<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const form = $('#formDecisao');
  const nameInput = $('#name');
  const ackTerms = $('#ack_terms');

  const overlay = $('#signatureOverlay');
  const btnOpen = $('#btnOpenSignature');
  const btnClose = $('#btnCloseSignature');
  const btnCancel = $('#btnCancel');
  const btnConfirm = $('#btnConfirm');
  const btnClear = $('#btnClear');

  const sigCanvas = $('#sigCanvas');
  const sigHint = $('#sigHint');
  const signerName = $('#signerName');
  const acceptTerms = $('#acceptTerms');

  const decisionField = $('#decisionField');
  const sigField = $('#signature_png');
  const tzField = $('#tz');
  const uaField = $('#ua');

  let pad;

  function openModal(){
    overlay.setAttribute('aria-hidden','false');
    setTimeout(resizeCanvas, 40);
    if(!pad){
      pad = new SignaturePad(sigCanvas, { minWidth: 0.7, maxWidth: 2.5, throttle: 16, penColor: '#0f172a' });
    } else {
      pad.clear();
    }
    sigHint.classList.add('d-none');
    if (!signerName.value && nameInput && nameInput.value) {
      signerName.value = nameInput.value;
    }
  }
  function closeModal(){
    overlay.setAttribute('aria-hidden','true');
    sigHint.classList.add('d-none');
    if(pad) pad.clear();
  }
  function resizeCanvas(){
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const rect = sigCanvas.getBoundingClientRect();
    sigCanvas.width = rect.width * ratio;
    sigCanvas.height = 220 * ratio;
    const ctx = sigCanvas.getContext('2d');
    ctx.scale(ratio, ratio);
  }
  window.addEventListener('resize', resizeCanvas);

  btnOpen && btnOpen.addEventListener('click', openModal);
  btnClose && btnClose.addEventListener('click', closeModal);
  overlay && overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); });
  btnCancel && btnCancel.addEventListener('click', closeModal);
  btnClear && btnClear.addEventListener('click', ()=>{ pad && pad.clear(); sigHint.classList.add('d-none'); });

  btnConfirm && btnConfirm.addEventListener('click', ()=>{
    if(!pad || pad.isEmpty()){ sigHint.classList.remove('d-none'); return; }
    if(!acceptTerms.checked){ alert('Voc√™ precisa aceitar os termos no modal.'); return; }
    if(ackTerms && !ackTerms.checked){ alert('Voc√™ precisa marcar a confirma√ß√£o de confer√™ncia.'); return; }

    if(nameInput && !nameInput.value && signerName.value){
      nameInput.value = signerName.value;
    }

    decisionField.value = 'approve';
    sigField.value = pad.toDataURL('image/png');
    tzField.value = (Intl.DateTimeFormat().resolvedOptions().timeZone || '');
    uaField.value = (navigator.userAgent || '');

    if(typeof form?.requestSubmit === 'function'){ form.requestSubmit(); }
    else { form?.submit(); }
  });
})();
</script>
</body>
</html>
