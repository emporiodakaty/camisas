<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>{% if form.instance.pk %}Editar{% else %}Novo{% endif %} Pedido • Camisas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{--ink:#0f172a;--ring:rgba(37,99,235,.18);--g1:#f30c80;--g2:#f30c80;--base-font:14px;}
    html{font-size:var(--base-font);} body{background:#f6f8fb;color:var(--ink);}
    .nav-pro{background:linear-gradient(90deg,var(--g1),var(--g2));}
    .card{border:none;box-shadow:0 10px 24px rgba(17,24,39,.08);border-radius:.9rem;}
    .form-control:focus,.form-select:focus{box-shadow:0 0 0 .25rem var(--ring);border-color:#93c5fd}
    .muted{color:#64748b}
    .table thead th{font-size:.78rem;text-transform:uppercase;letter-spacing:.04em;color:#64748b;border-top:0}
    .btn-sm{font-size:.82rem}
    .totals{background:#fff;border:1px solid #e5e7eb;border-radius:.8rem;padding:.75rem 1rem}
  </style>
</head>
<body>
<nav class="navbar nav-pro navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{% url 'camisas:pedido_list' %}">Pedidos</a>
    <div class="ms-auto"><a class="btn btn-sm btn-light" href="{% url 'camisas:pedido_list' %}">Voltar</a></div>
  </div>
</nav>

<main class="container py-4">
  {% for message in messages %}<div class="alert alert-{{ message.tags }}">{{ message }}</div>{% endfor %}

{# ===== RESUMO DE ERROS (sem parênteses) ===== #}
{% if form.errors or form.non_field_errors or formset.non_form_errors or formset.errors %}
  <div class="alert alert-danger">
    <strong>Corrija os erros abaixo para salvar o pedido:</strong>
    <ul class="mb-0 mt-2">
      {# Pedido (form principal) #}
      {% for err in form.non_field_errors %}<li>{{ err }}</li>{% endfor %}
      {% for name, errs in form.errors.items %}
        {% for e in errs %}<li>{{ name|capfirst }}: {{ e }}</li>{% endfor %}
      {% endfor %}

      {# Itens (formset) #}
      {% for err in formset.non_form_errors %}<li>{{ err }}</li>{% endfor %}
      {% for f in formset.forms %}
        {% if f.non_field_errors %}
          <li>Um item possui erros:
            <ul>
              {% for err in f.non_field_errors %}<li>{{ err }}</li>{% endfor %}
            </ul>
          </li>
        {% endif %}
        {% if f.errors %}
          <li>Campos com erro neste item:
            <ul>
              {% for name, errs in f.errors.items %}
                {% for e in errs %}<li>{{ name|capfirst }}: {{ e }}</li>{% endfor %}
              {% endfor %}
            </ul>
          </li>
        {% endif %}

        {# Personalizações do item (sub-formset) #}
        {% if f.personalizacoes %}
          {% if f.personalizacoes.non_form_errors %}
            <li>Personalizações com erro:
              <ul>
                {% for err in f.personalizacoes.non_form_errors %}<li>{{ err }}</li>{% endfor %}
              </ul>
            </li>
          {% endif %}
          {# Percorre cada formulário de personalização e lista seus erros #}
          {% for pf in f.personalizacoes.forms %}
            {% if pf.errors %}
              <li>Uma linha de personalização possui erros:
                <ul>
                  {% for name, errs in pf.errors.items %}
                    {% for e in errs %}<li>{{ name|capfirst }}: {{ e }}</li>{% endfor %}
                  {% endfor %}
                </ul>
              </li>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endfor %}
    </ul>
  </div>
{% endif %}


  <div class="card p-3 bg-white">
    <h2 class="h6 mb-3">{% if form.instance.pk %}Editar{% else %}Novo{% endif %} Pedido / Orçamento</h2>

    {% load widget_tweaks %}
    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate id="formPedido">{% csrf_token %}
      {{ formset.management_form }}

      <!-- CABEÇALHO -->
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Empresa</label>
          {{ form.empresa|add_class:"form-select"|attr:"required" }}
          {% for e in form.empresa.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-4">
          <label class="form-label d-flex align-items-center justify-content-between">
            <span>Cliente</span>
            <span class="ms-2">
              <a class="btn btn-sm btn-outline-success" target="_blank" href="{% url 'camisas:cliente_create' %}?next={{ request.path|urlencode }}">+ Cliente</a>
              <a class="btn btn-sm btn-outline-secondary" href="" onclick="location.reload();return false;" title="Atualizar lista">↻</a>
            </span>
          </label>
          {{ form.cliente|add_class:"form-select"|attr:"required" }}
          {% for e in form.cliente.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-4">
          <label class="form-label">Status</label>
          {{ form.status|add_class:"form-select"|attr:"required" }}
          {% for e in form.status.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-4">
          <label class="form-label">Nº Orçamento</label>
          {{ form.numero_orcamento|add_class:"form-control" }}
          {% for e in form.numero_orcamento.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="col-md-4">
          <label class="form-label">Validade</label>
          {{ form.validade|add_class:"form-control" }}
          {% for e in form.validade.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="col-md-4">
          <label class="form-label">Data de Entrega</label>
          {{ form.data_entrega|add_class:"form-control" }}
          {% for e in form.data_entrega.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="col-md-4">
          <label class="form-label">Arte da camisa (imagem)</label>
          {{ form.arte|add_class:"form-control" }}
          {% for e in form.arte.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-md-6">
          <label class="form-label">Desconto (%)</label>
          {{ form.desconto_percentual|add_class:"form-control perc" }}
          {% for e in form.desconto_percentual.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="col-md-6">
          <label class="form-label">Acréscimo (%)</label>
          {{ form.acrescimo_percentual|add_class:"form-control perc" }}
          {% for e in form.acrescimo_percentual.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>

        <div class="col-12">
          <label class="form-label">Condições (pagamento, entrega, observações)</label>
          {{ form.condicoes|add_class:"form-control" }}
          {% for e in form.condicoes.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="col-12">
          <label class="form-label">Observações internas</label>
          {{ form.observacao|add_class:"form-control" }}
          {% for e in form.observacao.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
      </div>

      <!-- ITENS -->
      <hr class="my-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 class="h6 m-0">Itens do Pedido</h3>
        <button type="button" id="btnAddRow" class="btn btn-sm btn-outline-primary">+ Adicionar item</button>
      </div>

      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th style="width:40%">Variação / Produto</th>
              <th style="width:15%">Qtd</th>
              <th style="width:15%">Preço unit. (R$)</th>
              <th style="width:20%">Subtotal</th>
              <th style="width:10%"></th>
            </tr>
          </thead>
          <tbody id="bodyItens">
            {% for f in formset.forms %}
              <tr class="row-item">
                <td>
                  <select name="{{ f.variacao.html_name }}" class="form-select item-variacao" id="{{ f.variacao.id_for_label }}" required>
                    <option value="">-- selecione --</option>
                  </select>
                  {{ f.id }}
                  {% if formset.can_delete %}{{ f.DELETE|add_class:"d-none del-flag" }}{% endif %}
                  {% for e in f.variacao.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                </td>
                <td>
                  {{ f.quantidade|add_class:"form-control item-qty"|attr:"step=0.01"|attr:"min=0.01"|attr:"required" }}
                  {% for e in f.quantidade.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                </td>
                <td>
                  {{ f.preco_unitario|add_class:"form-control item-price"|attr:"step=0.01"|attr:"min=0"|attr:"required" }}
                  {% for e in f.preco_unitario.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
                </td>
                <td class="item-subtotal fw-semibold">R$ 0,00</td>
                <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger btn-remove">Remover</button></td>
              </tr>

              <tr class="bg-light small">
                <td colspan="5">
                  <div class="personalizacoes-wrapper" data-prefix="{{ f.personalizacoes.prefix }}">
                    <h6 class="small fw-bold">Personalizações deste item</h6>
                    {{ f.personalizacoes.management_form }}
                    <table class="table table-sm mb-2">
                      <thead>
                        <tr>
                          <th>Nome</th>
                          <th>Número</th>
                          <th>Outra info</th>
                          <th>Tam. Camisa</th>
                          <th>Qtd</th>
                          <th>Short?</th>
                          <th>Tam. Short</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for p in f.personalizacoes.forms %}
                          <tr class="p-row">
                            <td>{{ p.nome|add_class:"form-control form-control-sm" }}{% for e in p.nome.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}</td>
                            <td>{{ p.numero|add_class:"form-control form-control-sm" }}{% for e in p.numero.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}</td>
                            <td>{{ p.outra_info|add_class:"form-control form-control-sm" }}{% for e in p.outra_info.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}</td>
                            <td>{{ p.tamanho_camisa|add_class:"form-select form-select-sm" }}{% for e in p.tamanho_camisa.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}</td>
                            <td>{{ p.quantidade|add_class:"form-control form-control-sm"|attr:"min=1"|attr:"step=1" }}{% for e in p.quantidade.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}</td>
                            <td class="text-center">{{ p.incluir_short }}</td>
                            <td>{{ p.tamanho_short|add_class:"form-control form-control-sm" }}{% for e in p.tamanho_short.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}</td>
                            <td class="text-end">
                              {% if f.personalizacoes.can_delete %}
                                {{ p.DELETE|add_class:"d-none del-flag" }}
                              {% endif %}
                              <button type="button" class="btn btn-sm btn-outline-danger btn-remove-personalizacao">Remover</button>
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>

                    <template class="tpl-personalizacao">
                      <tr class="p-row">
                        <td>{{ f.personalizacoes.empty_form.nome|add_class:"form-control form-control-sm" }}</td>
                        <td>{{ f.personalizacoes.empty_form.numero|add_class:"form-control form-control-sm" }}</td>
                        <td>{{ f.personalizacoes.empty_form.outra_info|add_class:"form-control form-control-sm" }}</td>
                        <td>{{ f.personalizacoes.empty_form.tamanho_camisa|add_class:"form-select form-select-sm" }}</td>
                        <td>{{ f.personalizacoes.empty_form.quantidade|add_class:"form-control form-control-sm"|attr:"min=1"|attr:"step=1" }}</td>
                        <td class="text-center">{{ f.personalizacoes.empty_form.incluir_short }}</td>
                        <td>{{ f.personalizacoes.empty_form.tamanho_short|add_class:"form-control form-control-sm" }}</td>
                        <td class="text-end">
                          {% if f.personalizacoes.can_delete %}
                            {{ f.personalizacoes.empty_form.DELETE|add_class:"d-none del-flag" }}
                          {% endif %}
                          <button type="button" class="btn btn-sm btn-outline-danger btn-remove-personalizacao">Remover</button>
                        </td>
                      </tr>
                    </template>

                    <button type="button" class="btn btn-sm btn-outline-primary btn-add-personalizacao">+ Adicionar personalização</button>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- PROTÓTIPOS PARA NOVOS ITENS -->
      <template id="tplItemRow">
        <tr class="row-item">
          <td>
            {{ formset.empty_form.variacao|add_class:"form-select item-variacao"|attr:"required" }}
            {{ formset.empty_form.id }}
            {% if formset.can_delete %}{{ formset.empty_form.DELETE|add_class:"d-none del-flag" }}{% endif %}
          </td>
          <td>{{ formset.empty_form.quantidade|add_class:"form-control item-qty"|attr:"step=0.01"|attr:"min=0.01"|attr:"required" }}</td>
          <td>{{ formset.empty_form.preco_unitario|add_class:"form-control item-price"|attr:"step=0.01"|attr:"min=0"|attr:"required" }}</td>
          <td class="item-subtotal fw-semibold">R$ 0,00</td>
          <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger btn-remove">Remover</button></td>
        </tr>
      </template>

      <template id="tplPersonalizacoesBlock">
        <tr class="bg-light small">
          <td colspan="5">
            <div class="personalizacoes-wrapper" data-prefix="__PFX__">
              <h6 class="small fw-bold">Personalizações deste item</h6>
              <input type="hidden" name="__PFX__-TOTAL_FORMS" value="0">
              <input type="hidden" name="__PFX__-INITIAL_FORMS" value="0">
              <input type="hidden" name="__PFX__-MIN_NUM_FORMS" value="0">
              <input type="hidden" name="__PFX__-MAX_NUM_FORMS" value="1000">
              <table class="table table-sm mb-2">
                <thead>
                  <tr>
                    <th>Nome</th><th>Número</th><th>Outra info</th><th>Tam. Camisa</th><th>Qtd</th><th>Short?</th><th>Tam. Short</th><th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <template class="tpl-personalizacao">
                <tr class="p-row">
                  <td><input type="text" name="__PFX__-__PITEM__-nome" class="form-control form-control-sm"></td>
                  <td><input type="text" name="__PFX__-__PITEM__-numero" class="form-control form-control-sm"></td>
                  <td><input type="text" name="__PFX__-__PITEM__-outra_info" class="form-control form-control-sm"></td>
                  <td>
                    <select name="__PFX__-__PITEM__-tamanho_camisa" class="form-select form-select-sm">
                      <option value=""></option>
                      <option>PP</option><option>P</option><option>M</option><option>G</option><option>GG</option><option>XG</option>
                      <option>PP-BL</option><option>P-BL</option><option>M-BL</option><option>G-BL</option><option>GG-BL</option><option>XG-BL</option>
                    </select>
                  </td>
                  <td><input type="number" min="1" step="1" value="1" name="__PFX__-__PITEM__-quantidade" class="form-control form-control-sm"></td>
                  <td class="text-center"><input type="checkbox" name="__PFX__-__PITEM__-incluir_short"></td>
                  <td><input type="text" name="__PFX__-__PITEM__-tamanho_short" class="form-control form-control-sm"></td>
                  <td class="text-end">
                    <input type="checkbox" class="del-flag d-none" name="__PFX__-__PITEM__-DELETE">
                    <button type="button" class="btn btn-sm btn-outline-danger btn-remove-personalizacao">Remover</button>
                  </td>
                </tr>
              </template>
              <button type="button" class="btn btn-sm btn-outline-primary btn-add-personalizacao">+ Adicionar personalização</button>
            </div>
          </td>
        </tr>
      </template>

      <!-- Totais -->
      <div class="row justify-content-end mt-3">
        <div class="col-md-5">
          <div class="totals">
            <div class="d-flex justify-content-between"><span class="muted">Subtotal</span><span id="tSub">R$ 0,00</span></div>
            <div class="d-flex justify-content-between"><span class="muted">Desconto</span><span id="tDesc">R$ 0,00</span></div>
            <div class="d-flex justify-content-between"><span class="muted">Acréscimo</span><span id="tAcr">R$ 0,00</span></div>
            <hr class="my-2">
            <div class="d-flex justify-content-between fw-bold"><span>Total</span><span id="tTotal">R$ 0,00</span></div>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-primary">Salvar</button>
        <a class="btn btn-outline-secondary" href="{% url 'camisas:pedido_list' %}">Cancelar</a>
        {% if form.instance.pk %}
          <a class="btn btn-success" href="{% url 'camisas:pedido_orcamento' form.instance.pk %}" target="_blank" rel="noopener">Ver Orçamento</a>
        {% endif %}
      </div>
      <p class="muted small mt-2">Os itens são salvos junto com o pedido. Depois, gere o orçamento para o cliente.</p>
    </form>
  </div>
</main>

<script>
(function(){
  const VARIACOES = {{ variacoes_json|safe }};
  const fmtBR = v => (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const toNum = v => { const x=(v||'').toString().replace(/\./g,'').replace(',','.').replace(/[^\d.-]/g,''); const n=parseFloat(x); return isNaN(n)?0:n; };

  const $form = document.getElementById('formPedido');
  const $tbody = document.getElementById('bodyItens');
  const $empresa = document.getElementById('{{ form.empresa.id_for_label }}');
  const $desc = document.getElementById('{{ form.desconto_percentual.id_for_label }}');
  const $acrc = document.getElementById('{{ form.acrescimo_percentual.id_for_label }}');
  const $tSub = document.getElementById('tSub'), $tDesc = document.getElementById('tDesc'), $tAcr = document.getElementById('tAcr'), $tTotal = document.getElementById('tTotal');

  // Indexa variações por empresa
  const byEmp = {};
  VARIACOES.forEach(v=>{
    const eid = String(v['produto__empresa_id']||'');
    (byEmp[eid]||(byEmp[eid]=[])).push(v);
  });

  function buildOptions(select, empresaId, keepSelected=true){
    const prev = keepSelected ? select.value : '';
    const list = empresaId ? (byEmp[String(empresaId)]||[]) : VARIACOES;
    select.innerHTML = '<option value="">-- selecione --</option>' + list.map(v=>{
      const rotulo = `${v['produto__nome']} / ${v.tipo}`;
      return `<option value="${v.id}" data-preco="${v.preco_sugerido||0}">${rotulo}</option>`;
    }).join('');
    if (keepSelected && prev){
      const opt = Array.from(select.options).find(o=> o.value===prev);
      if (opt) select.value = prev;
    }
  }

  function getSuggested($sel){
    const opt = $sel.options[$sel.selectedIndex];
    return toNum(opt?.dataset?.preco || 0);
  }

  function setSuggestedPrice(tr){
    const $sel = tr.querySelector('.item-variacao');
    const $prc = tr.querySelector('.item-price');
    if(!$sel || !$prc) return;
    const sug = getSuggested($sel);
    if(sug > 0){
      $prc.value = sug.toFixed(2).replace('.', ',');
    }
  }

  function bindRow(tr){
    const $sel = tr.querySelector('.item-variacao');
    const $qty = tr.querySelector('.item-qty');
    const $prc = tr.querySelector('.item-price');
    const $btn = tr.querySelector('.btn-remove');
    const $del = tr.querySelector('.del-flag');

    if($empresa){ buildOptions($sel, $empresa.value, true); }
    setSuggestedPrice(tr);

    $sel.addEventListener('change', ()=>{ setSuggestedPrice(tr); recalc(); });
    [$qty,$prc].forEach(el=> el && el.addEventListener('input', recalc));

    $btn && $btn.addEventListener('click', ()=>{
      if($del){ if($del.type==='checkbox') $del.checked = true; tr.style.display='none'; }
      else {
        const next = tr.nextElementSibling;
        if(next && next.classList.contains('bg-light')) next.remove();
        tr.remove();
      }
      recalc();
    });
  }

  function recalc(){
    let subtotal = 0;
    $tbody.querySelectorAll('.row-item').forEach(tr=>{
      if(tr.style.display==='none') return;
      const q = toNum(tr.querySelector('.item-qty')?.value);
      const p = toNum(tr.querySelector('.item-price')?.value);
      const st = q * p;
      tr.querySelector('.item-subtotal').textContent = fmtBR(st);
      subtotal += st;
    });
    const d = Math.max(0,toNum($desc?.value)), a = Math.max(0,toNum($acrc?.value));
    const valDesc = subtotal*(d/100), valAcr = subtotal*(a/100);
    const total = subtotal - valDesc + valAcr;
    $tSub.textContent = fmtBR(subtotal);
    $tDesc.textContent = fmtBR(valDesc);
    $tAcr.textContent  = fmtBR(valAcr);
    $tTotal.textContent= fmtBR(total);
  }

  // Linhas existentes
  $tbody.querySelectorAll('.row-item').forEach(tr=>{ bindRow(tr); setSuggestedPrice(tr); });
  recalc();

  // Refiltra por empresa
  $empresa && $empresa.addEventListener('change', ()=>{
    $tbody.querySelectorAll('.row-item').forEach(tr=>{
      const $sel = tr.querySelector('.item-variacao');
      const selectedBefore = $sel.value;
      buildOptions($sel, $empresa.value, true);
      if ($sel.value !== selectedBefore){
        $sel.dispatchEvent(new Event('change'));
      }else{
        setSuggestedPrice(tr); recalc();
      }
    });
  });

  // Validação HTML5
  $form.addEventListener('submit', (e)=>{
    if(!$form.checkValidity()){
      e.preventDefault(); e.stopPropagation(); $form.classList.add('was-validated');
      const firstInvalid = $form.querySelector(':invalid');
      if(firstInvalid){ firstInvalid.scrollIntoView({behavior:'smooth',block:'center'}); firstInvalid.focus(); }
    }
  });

  // Personalizações (linhas existentes)
  function addPersonalizacao(wrapper){
    const prefix = wrapper.dataset.prefix;
    const totalInput = wrapper.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);
    const tbody = wrapper.querySelector('tbody');
    const tpl = wrapper.querySelector('template.tpl-personalizacao');
    if(!totalInput || !tbody || !tpl) return;
    const idx = parseInt(totalInput.value || "0", 10);
    const temp = document.createElement('tbody');
    temp.innerHTML = tpl.innerHTML.replaceAll('__prefix__', idx).trim();
    const row = temp.firstElementChild;
    tbody.appendChild(row);
    totalInput.value = idx + 1;
  }

  document.addEventListener('click', function(ev){
    const addBtn = ev.target.closest('.btn-add-personalizacao');
    if(addBtn){
      const wrapper = addBtn.closest('.personalizacoes-wrapper');
      if(wrapper) addPersonalizacao(wrapper);
    }
    const rmBtn = ev.target.closest('.btn-remove-personalizacao');
    if(rmBtn){
      const row = rmBtn.closest('tr.p-row');
      if(!row) return;
      const del = row.querySelector('.del-flag');
      if(del){ del.checked = true; row.style.display = 'none'; }
      else{ row.remove(); }
    }
  });

  // NOVO ITEM
  const btnAddRow = document.getElementById('btnAddRow');
  const tplItemRow = document.getElementById('tplItemRow');
  const tplPersBlock = document.getElementById('tplPersonalizacoesBlock');
  const mgmtTotal = document.querySelector('input[name="{{ formset.prefix }}-TOTAL_FORMS"]');

  btnAddRow && btnAddRow.addEventListener('click', ()=>{
    const idx = parseInt(mgmtTotal.value || "0", 10);

    // item
    const temp1 = document.createElement('tbody');
    temp1.innerHTML = tplItemRow.innerHTML.replaceAll('__prefix__', idx).trim();
    const itemRow = temp1.firstElementChild;

    // bloco de personalizações vazio para esse item
    const temp2 = document.createElement('tbody');
    const pfx = `personalizacoes-${idx}`;
    temp2.innerHTML = tplPersBlock.innerHTML.replaceAll('__PFX__', pfx).replaceAll('__PITEM__', '__PITEM__').trim();
    const persBlock = temp2.firstElementChild;

    $tbody.appendChild(itemRow);
    $tbody.appendChild(persBlock);

    mgmtTotal.value = idx + 1;

    const $sel = itemRow.querySelector('.item-variacao');
    const $wrapper = persBlock.querySelector('.personalizacoes-wrapper');
    $wrapper.dataset.prefix = pfx;

    buildOptions($sel, $empresa ? $empresa.value : null, false);
    bindRow(itemRow);
    recalc();
  });

})();
</script>

</body>
</html>
