<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Pedidos â€¢ Camisas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{--ink:#0f172a;--muted:#64748b;--ring:rgba(37,99,235,.18);--g1:#f30c80;--g2:#f30c80;--base-font:14px;}
    html{font-size:var(--base-font);} body{background:#f6f8fb;color:var(--ink);}
    .nav-pro{background:linear-gradient(90deg,var(--g1),var(--g2));}
    .sticky-topbar{position:sticky;top:0;z-index:20;background:#ffffffd6;backdrop-filter:blur(6px);}
    .toolbar .form-control,.toolbar .form-select{border-radius:.6rem;border-color:#e5e7eb;font-size:.85rem;padding:.35rem .5rem}
    .toolbar .form-control:focus,.toolbar .form-select:focus{box-shadow:0 0 0 .25rem var(--ring);border-color:#93c5fd}
    .table{font-size:.875rem}.table thead th{font-size:.78rem;text-transform:uppercase;letter-spacing:.04em;color:#64748b;border-top:0}
    .card-surface{background:#fff;border:1px solid #e5e7eb;border-radius:.9rem}
    .badge-soft{background:#eef2f7;color:#334155}
    .mini{font-size:.85rem;color:var(--muted)}
    .row-edit{background:#f8fafc;}
  </style>
</head>
<body>
<nav class="navbar nav-pro navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{% url 'camisas:home' %}">Camisas</a>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-sm btn-primary" href="{% url 'camisas:pedido_create' %}">+ Novo pedido</a>
    </div>
  </div>
</nav>

<main class="container py-3 py-lg-4">
  {% for message in messages %}<div class="alert alert-{{ message.tags }} shadow-sm">{{ message }}</div>{% endfor %}

  <!-- Filtros -->
  <div class="sticky-topbar border rounded-3 p-3 mb-3 toolbar">
    <form class="row g-2 align-items-end">
      <div class="col-12 col-md-4">
        <label class="form-label small text-muted mb-1" for="q">Buscar</label>
        <div class="input-group">
          <span class="input-group-text bg-white">ðŸ”Ž</span>
          <input id="q" name="q" type="search" value="{{ sel.q }}" class="form-control"
                 placeholder="Cliente, NÂº orÃ§amentoâ€¦">
        </div>
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label small text-muted mb-1" for="emp">Empresa</label>
        <select id="emp" name="empresa" class="form-select">
          <option value="">Todas</option>
          {% for e in empresas %}
            <option value="{{ e.id }}" {% if sel.empresa == e.id|stringformat:"s" %}selected{% endif %}>
              {{ e.nome_fantasia }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label small text-muted mb-1" for="st">Status</label>
        <select id="st" name="status" class="form-select">
          <option value="">Todos</option>
          {% for code, label in pedido.STATUS %}
            <option value="{{ code }}" {% if sel.status == code %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-2 d-grid">
        <button class="btn btn-primary">Filtrar</button>
      </div>
    </form>
  </div>

  {% if rows %}
  <div class="card-surface overflow-hidden">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th style="width:8%">#</th>
            <th style="width:18%">NÂº OrÃ§amento</th>
            <th style="width:22%">Cliente</th>
            <th style="width:18%">Empresa</th>
            <th style="width:14%">Status</th>
            <th style="width:12%">Total</th>
            <th style="width:8%" class="text-end">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td class="text-monospace">{{ r.id }}</td>
            <td>
              {% if r.numero_orcamento %}{{ r.numero_orcamento }}{% else %}<span class="text-muted">â€”</span>{% endif %}
              {% if r.approval_status %}
              <div class="mini">AprovaÃ§Ã£o:
                <span class="badge {% if r.approval_status == 'APRV' %}text-bg-success{% elif r.approval_status == 'REJ' %}text-bg-danger{% else %}text-bg-secondary{% endif %}">
                  {{ r.approval_status_label }}
                </span>
              </div>
              {% endif %}
            </td>
            <td>
              {{ r.cliente }}
              {% if r.can_edit_client %}
                <div class="mini">
                  <a class="link-secondary" data-bs-toggle="collapse" href="#chg-{{ r.id }}" role="button" aria-expanded="false" aria-controls="chg-{{ r.id }}">
                    Alterar cliente
                  </a>
                </div>
              {% endif %}
            </td>
            <td>{{ r.empresa }}</td>
            <td>
              <span class="badge {% if r.status == 'FAT' %}text-bg-success{% elif r.status == 'PROD' %}text-bg-primary{% elif r.status == 'PEN' %}text-bg-warning{% elif r.status == 'ORC' %}text-bg-secondary{% else %}text-bg-dark{% endif %}">
                {{ r.status_label }}
              </span>
              <div class="mini">{{ r.criado_em|date:"d/m/Y H:i" }}</div>
            </td>
            <td>R$ {{ r.total|floatformat:2 }}</td>
            <td class="text-end">
              <div class="btn-group">
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'camisas:pedido_detail' r.id %}">Abrir</a>
                <a class="btn btn-sm btn-outline-warning" href="{% url 'camisas:pedido_update' r.id %}">Editar</a>

                {% if r.approval_token %}
                  {% url 'camisas:orcamento_publico' token=r.approval_token as pub_path %}
                  <button class="btn btn-sm btn-outline-primary" type="button"
                          onclick="copyLink('{{ request.scheme }}://{{ request.get_host }}{{ pub_path }}', this)">
                    Link
                  </button>
                {% endif %}

                <form method="post" action="{% url 'camisas:pedido_delete' r.id %}" class="d-inline"
                      onsubmit="return confirm('Excluir o pedido #{{ r.id }}? Esta aÃ§Ã£o nÃ£o pode ser desfeita.');">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-danger" type="submit">Excluir</button>
                </form>
              </div>
            </td>
          </tr>

          {% if r.can_edit_client %}
          <!-- Linha de ediÃ§Ã£o (collapse) -->
          <tr class="row-edit collapse" id="chg-{{ r.id }}">
            <td colspan="7">
              <form class="row g-2 align-items-end" method="post" action="{% url 'camisas:pedido_alterar_cliente' r.id %}">
                {% csrf_token %}
                <div class="col-12 col-md-6">
                  <label class="form-label mini">Novo cliente para o pedido #{{ r.id }}</label>
                  <select name="cliente_id" class="form-select">
                    {% for c in clientes_all %}
                      <option value="{{ c.id }}" {% if c.id == r.cliente_id %}selected{% endif %}>
                        {{ c.nome }}{% if c.cpf_cnpj %} â€” {{ c.cpf_cnpj }}{% endif %}
                      </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-6 col-md-3">
                  <button class="btn btn-dark w-100">Salvar</button>
                </div>
                <div class="col-6 col-md-3">
                  <a class="btn btn-outline-secondary w-100" data-bs-toggle="collapse" href="#chg-{{ r.id }}">Cancelar</a>
                </div>
                <input type="hidden" name="next" value="{{ request.get_full_path|urlencode }}">
              </form>
            </td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
    <div class="border rounded-3 bg-white p-4 text-center text-muted">
      Nenhum pedido encontrado.
    </div>
  {% endif %}
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function copyLink(text, el){
  navigator.clipboard.writeText(text).then(()=>{
    const old = el.innerText;
    el.innerText = "Copiado!";
    setTimeout(()=> el.innerText = old, 1200);
  }).catch(()=>{
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    const old = el.innerText;
    el.innerText = "Copiado!";
    setTimeout(()=> el.innerText = old, 1200);
  });
}
</script>
</body>
</html>
