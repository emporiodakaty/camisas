<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Camisas • Nova Remessa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --ring:rgba(37,99,235,.18); --g1:#f30c80; --g2:#f30c80; --base-font:14px; }
    html{ font-size:var(--base-font); }
    body{ background:#f6f8fb; color:var(--ink); }

    .nav-pro{ background:linear-gradient(90deg,var(--g1),var(--g2)); }
    .card-clean{ border:none; border-radius:.9rem; box-shadow:0 10px 24px rgba(17,24,39,.08); }
    .table{ font-size:.875rem; }
    .table thead th{ font-size:.78rem; text-transform:uppercase; letter-spacing:.04em; color:#64748b; border-top:0; }
    .mini{ font-size:.8rem; color:var(--muted); }
    .badge-soft{ background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }
    .btn-sm{ font-size:.82rem; }
    .form-control:focus, .form-select:focus{ box-shadow:0 0 0 .25rem var(--ring); border-color:#93c5fd; }

    /* Inputs compactos na tabela */
    .table input[type="number"], .table select { height:34px; padding:.25rem .5rem; }
    .w-80{ min-width:80px; }

    /* Totais por tamanho */
    .totais-grade{ display:grid; grid-template-columns: repeat(6, 1fr); gap:.4rem; }
    @media (min-width: 992px){ .totais-grade{ grid-template-columns: repeat(12, 1fr); } }
    .tot-card{ background:#fff; border:1px solid #e5e7eb; border-radius:.65rem; padding:.4rem .55rem; text-align:center; }
    .tot-card .t{ font-size:.7rem; color:#64748b; text-transform:uppercase; letter-spacing:.04em; }
    .tot-card .v{ font-weight:800; font-size:.95rem; }
    .tag{ background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:.2rem .55rem; font-weight:700; font-size:.78rem; }

    .field-error{ font-size:.75rem; color:#dc2626; margin-top:.2rem; }
  </style>
</head>
<body>

<nav class="navbar nav-pro navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{% url 'camisas:home' %}">YLA Criativa • Camisas</a>
    <div class="d-flex flex-wrap gap-2 ms-auto">
      <a class="btn btn-sm btn-light" href="{% url 'camisas:empresa_list' %}">Empresas</a>
      <a class="btn btn-sm btn-light" href="{% url 'camisas:cliente_list' %}">Clientes</a>
      <a class="btn btn-sm btn-light" href="{% url 'camisas:insumo_list' %}">Insumos</a>
      <a class="btn btn-sm btn-light" href="{% url 'camisas:produto_list' %}">Produtos</a>
      <a class="btn btn-sm btn-light" href="{% url 'camisas:remessa_list' %}">Remessas</a>
      <a class="btn btn-sm btn-success" href="{% url 'camisas:remessa_create' %}">+ Nova remessa</a>
      <a class="btn btn-sm btn-warning" href="{% url 'camisas:op_create' %}">Ordem Produção</a>
      <a class="btn btn-sm btn-info" href="{% url 'camisas:pedido_list' %}">Pedidos</a>
    </div>
  </div>
</nav>

<main class="container py-4">

  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}

  <!-- Erros do form principal -->
  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      {% for e in form.non_field_errors %}<div>• {{ e }}</div>{% endfor %}
    </div>
  {% endif %}

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h5 m-0">Nova Remessa</h1>
      <div class="mini">Informe empresa, costureira e tipo; depois defina os itens. Se o <strong>Preço</strong> ficar em branco/zero, usaremos o preço padrão da costureira para o tipo. O <strong>Total</strong> da linha e o <strong>Total previsto (R$)</strong> são calculados automaticamente.</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'camisas:remessa_list' %}">Voltar</a>
    </div>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}

    <!-- Dados da Remessa -->
    <div class="card-clean p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0">Dados da remessa</h2>
        <span class="badge badge-soft">Formulário</span>
      </div>
      <div class="row g-3">
        {% for f in form %}
          <div class="col-md-6">
            <label class="form-label mini">{{ f.label }}</label>
            {{ f }}
            {% if f.help_text %}<div class="form-text">{{ f.help_text }}</div>{% endif %}
            {% for e in f.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
          </div>
        {% endfor %}
      </div>
      <div class="mini mt-2">Use <em>Kg enviados</em> para indicar a matéria-prima mandada na remessa; as baixas de insumos ocorrem no recebimento conforme a fase configurada.</div>
    </div>

    <!-- Legenda de tamanhos -->
    <div class="card-clean p-3 mb-3">
      <div class="d-flex flex-wrap gap-2">
        <div class="mini">Tamanhos:</div>
        {% for t in tamanhos %}<span class="tag">{{ t }}</span>{% endfor %}
      </div>
    </div>

    <!-- Itens -->
    <div class="card-clean p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0">Itens / Previsto por tamanho</h2>
        <div class="d-flex gap-2">
          <button type="button" id="btnAddRow" class="btn btn-outline-primary btn-sm">Adicionar item</button>
          <button type="button" id="btnZero" class="btn btn-outline-secondary btn-sm">Zerar</button>
        </div>
      </div>

      {{ formset.management_form }}

      <!-- Erros globais do formset -->
      {% if formset.non_form_errors %}
        <div class="alert alert-danger mb-2">
          {% for e in formset.non_form_errors %}<div>• {{ e }}</div>{% endfor %}
        </div>
      {% endif %}

      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th style="min-width:260px">Variação (Produto / Tamanho / Cor)</th>
              <th style="width:120px">Tamanho</th>
              <th style="width:160px">Cor</th>
              <th style="width:140px">Previsto (peças)</th>
              <th style="width:140px">Preço</th>
              <th style="width:160px">Total (R$)</th>
              <th style="width:90px" class="text-end">Remover</th>
            </tr>
          </thead>
          <tbody id="itensBody">
            {% for row in formset %}
              <tr class="row-item">
                <td>
                  {{ row.variacao }}
                  {% for hf in row.hidden_fields %}{{ hf }}{% endfor %}
                  {% for e in row.variacao.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
                </td>
                <td class="fw-semibold tam-cell">
                  {% if row.instance.pk %}{{ row.instance.variacao.tamanho }}{% else %}—{% endif %}
                </td>
                <td class="cor-cell">
                  {% if row.instance.pk %}{{ row.instance.variacao.cor }}{% else %}—{% endif %}
                </td>
                <td class="w-80 previsto-cell">
                  {{ row.qtd_prevista }}
                  {% for e in row.qtd_prevista.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
                </td>
                <td class="w-80 price-cell">
                  {{ row.preco_unit }}
                  {% for e in row.preco_unit.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
                </td>
                <td class="line-total fw-semibold">R$ 0,00</td>
                <td class="text-end">
                  {% if row.can_delete %}
                    <label class="mini me-2 d-none">{{ row.DELETE }} Excluir</label>
                    <button type="button" class="btn btn-outline-danger btn-sm btnRemove">Remover</button>
                  {% endif %}
                </td>
              </tr>

              <!-- Erros não relacionados a campos (da linha) -->
              {% if row.non_field_errors %}
                <tr>
                  <td colspan="7">
                    <div class="field-error">
                      {% for e in row.non_field_errors %}<div>• {{ e }}</div>{% endfor %}
                    </div>
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="fw-bold">
              <td colspan="3" class="text-end">Total previsto (peças):</td>
              <td id="totPrev">0</td>
              <td class="text-end">Total previsto (R$):</td>
              <td id="totPrevMoney">R$ 0,00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Totais por tamanho (Previsto) -->
      <div class="mt-2">
        <div class="mini mb-1">Totais por tamanho (Previsto)</div>
        <div id="totBySize" class="totais-grade">
          {% for t in tamanhos %}
            <div class="tot-card" data-size="{{ t }}">
              <div class="t">{{ t }}</div>
              <div class="v">0</div>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="mini mt-2 text-muted">Ao escolher a variação, o <strong>Tamanho</strong> e a <strong>Cor</strong> da linha são preenchidos automaticamente. O sistema soma os previstos por tamanho e calcula os totais em R$.</div>
    </div>

    <div class="d-flex justify-content-end gap-2">
      <button class="btn btn-primary">Salvar</button>
    </div>

    <!-- Template de linha vazia -->
    <template id="tmplRow">
      <tr class="row-item">
        <td>__VARIACAO__ __HIDDENS__</td>
        <td class="fw-semibold tam-cell">—</td>
        <td class="cor-cell">—</td>
        <td class="w-80 previsto-cell">__QTD__</td>
        <td class="w-80 price-cell">__PRECO__</td>
        <td class="line-total fw-semibold">R$ 0,00</td>
        <td class="text-end">
          <label class="mini me-2 d-none">__DELETE__ Excluir</label>
          <button type="button" class="btn btn-outline-danger btn-sm btnRemove">Remover</button>
        </td>
      </tr>
    </template>

    <!-- placeholders do empty_form -->
    <div id="emptyFormParts" class="d-none">
      <div id="ef-variacao">{{ formset.empty_form.variacao }}</div>
      <div id="ef-qtd">{{ formset.empty_form.qtd_prevista }}</div>
      <div id="ef-preco">{{ formset.empty_form.preco_unit }}</div>
      <div id="ef-delete">{% if formset.can_delete %}{{ formset.empty_form.DELETE }}{% endif %}</div>
      <div id="ef-hiddens">{% for hf in formset.empty_form.hidden_fields %}{{ hf }}{% endfor %}</div>
    </div>
  </form>
</main>

<!-- injeta o mapa de preços base { costureira_id: {TIPO: valor} } -->
<script>
  const COST_MAP = {{ cost_map_json|safe }};
</script>

<script>
(function(){
  const q  = (s,r=document)=>r.querySelector(s);
  const qa = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const body = q('#itensBody');
  const totPrev = q('#totPrev');
  const totPrevMoney = q('#totPrevMoney');
  const totWrap = q('#totBySize');
  const SIZES = ['PP','P','M','G','GG','XGG','PPB','PB','MB','GB','GGB','XGGB'];

  const selTipo = q('#id_tipo');
  const selCost = q('#id_costureira');

  function toNumber(v){
    if (typeof v !== 'string') v = String(v ?? '');
    v = v.trim();
    if (!v) return 0;
    const hasDot = v.includes('.');
    const hasCom = v.includes(',');
    if (hasCom && !hasDot){ v = v.replace(/\./g,'').replace(',', '.'); return parseFloat(v)||0; }
    if (hasDot && !hasCom){ v = v.replace(/,/g,''); return parseFloat(v)||0; }
    if (hasDot && hasCom){
      const lastDot = v.lastIndexOf('.'); const lastCom = v.lastIndexOf(',');
      if (lastCom > lastDot){ v = v.replace(/\./g,'').replace(',', '.'); }
      else { v = v.replace(/,/g,''); }
      return parseFloat(v)||0;
    }
    return parseFloat(v)||0;
  }
  const toMoney = (n)=> (Number(n||0)).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const toIntBR = (n)=> (Math.round(n)||0).toLocaleString('pt-BR');

  const getBasePrice = ()=>{
    const costId = (selCost && selCost.value) ? selCost.value : null;
    const tipo   = (selTipo && selTipo.value) ? selTipo.value : 'COSTURA';
    if (!costId || !COST_MAP || !COST_MAP[costId]) return 0;
    return Number(COST_MAP[costId][tipo] || 0);
  };

  const extractSizeAndColor = (optText)=>{
    const parts = (optText||'').trim().split(' ');
    const last  = parts[parts.length-1] || '';
    const sc = last.split('/');
    return { size:(sc[0]||'').toUpperCase(), cor:(sc[1]||'').trim() };
  };

  function ensurePrice(inp){
    const val = toNumber(inp.value);
    if (!val){
      const base = getBasePrice();
      inp.value = Number(base||0).toFixed(2);
    }
  }

  function bindRow(tr){
    const sel = tr.querySelector('select');
    const inpQtd = tr.querySelector('input[name$="-qtd_prevista"]');
    const inpPre = tr.querySelector('input[name$="-preco_unit"]');
    const del    = tr.querySelector('input[name$="-DELETE"]');

    if (sel){
      sel.addEventListener('change', ()=>{
        const opt = sel.options[sel.selectedIndex];
        const {size, cor} = extractSizeAndColor(opt ? opt.text : '');
        q('.tam-cell', tr).textContent = size || '—';
        q('.cor-cell', tr).textContent = cor || '—';
        tr.dataset.size = size || '';
        if (inpPre) ensurePrice(inpPre);
        recalc();
      });
      const opt = sel.options[sel.selectedIndex];
      if (opt){
        const {size, cor} = extractSizeAndColor(opt.text);
        q('.tam-cell', tr).textContent = size || '—';
        q('.cor-cell', tr).textContent = cor || '—';
        tr.dataset.size = size || '';
      }
    }

    if (inpQtd){
      inpQtd.setAttribute('inputmode','numeric');
      inpQtd.setAttribute('min','0'); inpQtd.setAttribute('step','1');
      inpQtd.addEventListener('input', ()=>{
        if (inpPre) ensurePrice(inpPre);
        recalc();
      });
    }

    if (inpPre){
      inpPre.setAttribute('inputmode','decimal');
      inpPre.setAttribute('min','0'); inpPre.setAttribute('step','0.01');
      inpPre.addEventListener('focus', ()=> ensurePrice(inpPre));
      inpPre.addEventListener('input', recalc);
    }

    const btnR = tr.querySelector('.btnRemove');
    if (btnR){
      btnR.addEventListener('click', ()=>{
        if (del){ del.checked = true; }
        tr.style.display = 'none';
        recalc();
      });
    }
  }

  function recalc(){
    const rows = qa('tr.row-item', body).filter(tr => tr.style.display !== 'none');

    let totPecas = 0;
    let totMoney = 0;
    const mapSizes = Object.fromEntries(SIZES.map(s=>[s,0]));

    rows.forEach(tr=>{
      const inpQtd = tr.querySelector('input[name$="-qtd_prevista"]');
      const inpPre = tr.querySelector('input[name$="-preco_unit"]');

      const qty = toNumber(inpQtd && inpQtd.value);
      let  prc = toNumber(inpPre && inpPre.value);
      if (!prc){ prc = getBasePrice() || 0; }

      const line = qty * prc;
      const lineEl = tr.querySelector('.line-total');
      if (lineEl) lineEl.textContent = toMoney(line);

      totPecas += qty;
      totMoney += line;

      const size = (tr.dataset.size||'').toUpperCase();
      if (mapSizes[size] !== undefined) mapSizes[size] += qty;
    });

    if (totPrev) totPrev.textContent = toIntBR(totPecas);
    if (totPrevMoney) totPrevMoney.textContent = toMoney(totMoney);

    if (totWrap){
      SIZES.forEach(s=>{
        const el = totWrap.querySelector(`.tot-card[data-size="${s}"] .v`);
        if (el) el.textContent = toIntBR(mapSizes[s]);
      });
    }
  }

  function addRow(){
    const totalInp = q('input[name$="-TOTAL_FORMS"]', document);
    const idx = parseInt(totalInp.value, 10);
    const tmpl = q('#tmplRow').content.firstElementChild.cloneNode(true);

    function bake(html){ return html.replace(/__prefix__/g, idx); }
    tmpl.innerHTML = tmpl.innerHTML
      .replace('__VARIACAO__', bake(q('#ef-variacao').innerHTML))
      .replace('__QTD__',      bake(q('#ef-qtd').innerHTML))
      .replace('__PRECO__',    bake(q('#ef-preco').innerHTML))
      .replace('__DELETE__',   bake(q('#ef-delete').innerHTML))
      .replace('__HIDDENS__',  bake(q('#ef-hiddens').innerHTML));

    body.appendChild(tmpl);
    totalInp.value = idx + 1;
    const newRow = body.lastElementChild;
    bindRow(newRow);
    const inpPre = newRow.querySelector('input[name$="-preco_unit"]');
    if (inpPre) ensurePrice(inpPre);
    recalc();
  }

  function zeroAll(){
    qa('input[name$="-qtd_prevista"]', body).forEach(inp=> inp.value = '0');
    recalc();
  }

  [selCost, selTipo].forEach(el=>{
    el && el.addEventListener('change', ()=>{
      qa('tr.row-item', body).forEach(tr=>{
        const inpPre = tr.querySelector('input[name$="-preco_unit"]');
        if (!inpPre) return;
        if (!toNumber(inpPre.value)) ensurePrice(inpPre);
      });
      recalc();
    });
  });

  qa('tr.row-item', body).forEach(bindRow);
  qa('tr.row-item input[name$="-preco_unit"]', body).forEach(ensurePrice);
  recalc();

  q('#btnAddRow')?.addEventListener('click', addRow);
  q('#btnZero')?.addEventListener('click', zeroAll);
})();
</script>

</body>
</html>
