<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Frequência • Resumo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{ --ink:#2a0f1a; --muted:#64748b; --ring:rgba(37,99,235,.18); --g1:#f30c80; --g2:#f30c80; --base-font:14px; }
    html{ font-size:var(--base-font); } body{ background:#f6f8fb; color:var(--ink); }
    .nav-pro{ background:linear-gradient(90deg,var(--g1),var(--g2)); }
    .card-clean{ border:none; border-radius:.9rem; box-shadow:0 10px 24px rgba(17,24,39,.08); background:#fff; }
    .table thead th{ font-size:.78rem; text-transform:uppercase; letter-spacing:.04em; color:#64748b; border-top:0 }
    .mini{ font-size:.85rem; color:var(--muted); }
    .pill{ padding:.2rem .5rem; border-radius:.5rem; font-weight:600; }
    .ok{ background:#dcfce7 } .neg{ background:#fee2e2 }

    /* ---- Destaques por dia da semana ---- */
    tr.sat { background:#eef2ff; }   /* sábado - lilás claro */
    tr.sat:hover { background:#e0e7ff; }
    tr.sat td { border-top-color:#c7d2fe; }

    tr.sun { background:#fee2e2; }   /* domingo - vermelho claro */
    tr.sun:hover { background:#fecaca; }
    tr.sun td { border-top-color:#fecaca; }
  </style>
</head>
<body>
<nav class="navbar nav-pro navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{% url 'camisas:home' %}">EMPÓRIO DA KATY</a>
  </div>
</nav>

<main class="container py-4">
  {% include "camisas/_freq_nav.html" %}

  {% if messages %}
    <div class="mb-2">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} py-2 my-1">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="card-clean p-3 mb-3">
    <h1 class="h6 m-0">Frequência — Resumo mensal</h1>
    <form class="row g-2 mt-2" method="get" action="{% url 'camisas:freq_resumo' %}">
      <div class="col-md-5">{{ form.func }}</div>
      <div class="col-md-4">{{ form.mes }}</div>
      <div class="col-md-3 d-flex gap-2">
        <button class="btn btn-primary w-100">Aplicar</button>
        {% if form_ok and csv_qs %}
          <a class="btn btn-success" href="{% url 'camisas:freq_relatorio_csv' %}{{ csv_qs }}">CSV</a>
        {% endif %}
      </div>
    </form>
    {% if func %}
      <div class="mini mt-2">Funcionário: <strong>{{ func.nome }}</strong> • Período: {{ mes_ini|date:"d/m/Y" }} a {{ mes_fim|date:"d/m/Y" }}</div>
    {% endif %}
  </div>

  {% if linhas and totais %}
  <div class="card-clean p-3 mb-3">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Data</th>
            <th style="min-width:360px">Batidas / Lançamento</th>
            <th class="text-end">Previsto</th>
            <th class="text-end">Trabalhado</th>
            <th class="text-end">Saldo</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for l in linhas %}
            {% with fid=func.id|default:nav_fid ms=mes_str|default:nav_mes_str %}
            <tr class="{% if l.is_sat %}sat{% elif l.is_sun %}sun{% endif %}">
              <td class="fw-semibold">{{ l.data|date:"d/m/Y" }}</td>

              <!-- FORM INLINE (uma linha por dia) -->
              <td>
                <form method="post"
                      action="{% url 'camisas:freq_inline_upsert' %}"
                      class="row g-1 align-items-center"
                      data-inm="{{ func.h_in_manha|default_if_none:''|time:'H:i' }}"
                      data-inm2="{{ nav_func.h_in_manha|default_if_none:''|time:'H:i' }}"
                      data-outm="{{ func.h_out_manha|default_if_none:''|time:'H:i' }}"
                      data-outm2="{{ nav_func.h_out_manha|default_if_none:''|time:'H:i' }}"
                      data-int="{{ func.h_in_tarde|default_if_none:''|time:'H:i' }}"
                      data-int2="{{ nav_func.h_in_tarde|default_if_none:''|time:'H:i' }}"
                      data-outt="{{ func.h_out_tarde|default_if_none:''|time:'H:i' }}"
                      data-outt2="{{ nav_func.h_out_tarde|default_if_none:''|time:'H:i' }}">
                  {% csrf_token %}
                  <input type="hidden" name="func" value="{{ fid }}">
                  <input type="hidden" name="data" value="{{ l.data|date:'Y-m-d' }}">
                  <input type="hidden" name="mes"  value="{{ ms }}">

                  <div class="col-6 col-md-3">
                    <input type="time" name="e1" class="form-control form-control-sm"
                           value="{{ l.reg.e1|default_if_none:''|time:'H:i' }}" placeholder="Entrada manhã">
                  </div>
                  <div class="col-6 col-md-3">
                    <input type="time" name="s1" class="form-control form-control-sm"
                           value="{{ l.reg.s1|default_if_none:''|time:'H:i' }}" placeholder="Saída manhã">
                  </div>
                  <div class="col-6 col-md-3">
                    <input type="time" name="e2" class="form-control form-control-sm"
                           value="{{ l.reg.e2|default_if_none:''|time:'H:i' }}" placeholder="Entrada tarde">
                  </div>
                  <div class="col-6 col-md-3">
                    <input type="time" name="s2" class="form-control form-control-sm"
                           value="{{ l.reg.s2|default_if_none:''|time:'H:i' }}" placeholder="Saída tarde">
                  </div>

                  <div class="col-12 col-md-auto d-flex gap-1 mt-1">
                    <button class="btn btn-sm btn-primary">Lançar</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary btn-fill-padrao">Padrão</button>
                  </div>
                </form>
              </td>

              <td class="text-end">{{ l.hh_prev }}</td>
              <td class="text-end">{{ l.hh_trab }}</td>
              <td class="text-end">
                <span class="pill {% if l.saldo >= 0 %}ok{% else %}neg{% endif %}">{{ l.hh_saldo }}</span>
              </td>
              <td class="text-end">
                {% if l.reg %}
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'camisas:freq_editar' l.reg.id %}">Detalhes</a>
                {% else %}
                  <a class="btn btn-sm btn-outline-success" href="{% url 'camisas:freq_novo' %}?func={{ fid }}&data={{ l.data|date:'Y-m-d' }}">Form</a>
                {% endif %}
              </td>
            </tr>
            {% endwith %}
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="fw-bold">
            <td colspan="2" class="text-end">Totais</td>
            <td class="text-end">{{ totais.hh_prev }}</td>
            <td class="text-end">{{ totais.hh_trab }}</td>
            <td class="text-end">{{ totais.hh_saldo }}</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
  {% endif %}
</main>

<!-- Preenche 4 campos com horário padrão do funcionário (usa fallback nav_* se necessário) -->
<script>
(function(){
  document.querySelectorAll('.btn-fill-padrao').forEach(btn => {
    btn.addEventListener('click', () => {
      const f = btn.closest('form'); if(!f) return;
      const imm  = f.dataset.inm  || f.dataset.inm2  || "";
      const omm  = f.dataset.outm || f.dataset.outm2 || "";
      const it   = f.dataset.int  || f.dataset.int2  || "";
      const ot   = f.dataset.outt || f.dataset.outt2 || "";
      const $ = sel => f.querySelector(sel);
      if (imm) $('input[name="e1"]').value = imm;
      if (omm) $('input[name="s1"]').value = omm;
      if (it)  $('input[name="e2"]').value = it;
      if (ot)  $('input[name="s2"]').value = ot;
    });
  });
})();
</script>
</body>
</html>
