<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Camisas • Relatórios • Pagamentos a Costureiras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

<style>
  :root{ --ink:#2a0f1a; --muted:#64748b; --ring:rgba(37,99,235,.18); --g1:#f30c80; --g2:#f30c80; --base-font:14px; }
  html{ font-size:var(--base-font); } body{ background:#f6f8fb; color:var(--ink); }

  .nav-pro{ background:linear-gradient(90deg,var(--g1),var(--g2)); }
  .card-clean{ border:none; border-radius:.9rem; box-shadow:0 10px 24px rgba(17,24,39,.08); }
  .table{ font-size:.875rem; }
  .table thead th{ font-size:.78rem; text-transform:uppercase; letter-spacing:.04em; color:#64748b; border-top:0; }
  .mini{ font-size:.8rem; color:var(--muted); }
  .badge-soft{ background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }
  .btn-sm{ font-size:.82rem; }

  /* ===== Alinhamento e padronização da toolbar ===== */
  .toolbar .form-label{ margin-bottom:.25rem; line-height:1; }
  /* Padroniza altura/padding/width de todos os inputs da toolbar */
  .toolbar .form-control,
  .toolbar .form-select,
  .toolbar select,
  .toolbar input[type="text"],
  .toolbar input[type="number"],
  .toolbar input[type="date"],
  .toolbar input[type="datetime-local"]{
    height:38px;
    padding:.375rem .75rem;
    line-height:1.5;
    width:100%;
  }
  /* Firefox ajusta o padding do select de forma diferente */
  @-moz-document url-prefix() {
    .toolbar .form-select, .toolbar select{ padding-top:.375rem; padding-bottom:.375rem; }
  }
  /* Mantém a última linha alinhada por baixo com os botões */
  .toolbar .row{ align-items:end; }

  /* (Opcional) checkboxes/radios na toolbar, caso existam */
  .toolbar .form-check{ display:flex; align-items:center; gap:.5rem; min-height:38px; margin-bottom:0; }
  .toolbar .form-check .form-check-input{ margin-top:0; }
</style>

</head>
<body>

<!-- NAV igual ao home -->
<nav class="navbar nav-pro navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{% url 'camisas:home' %}">EMPÓRIO DA KATY</a>
    <div class="d-flex flex-wrap gap-2 ms-auto">
      <a class="btn btn-sm btn-light" href="{% url 'camisas:empresa_list' %}">Empresas</a>
      <a class="btn btn-sm btn-light" href="{% url 'camisas:cliente_list' %}">Clientes</a>
      <a class="btn btn-sm btn-light" href="{% url 'camisas:insumo_list' %}">Insumos</a>
      <a class="btn btn-sm btn-light" href="{% url 'camisas:produto_list' %}">Produtos</a>

      <!-- Remessas / Cadastros -->
      <a class="btn btn-sm btn-light" href="{% url 'camisas:remessa_list' %}">Remessas</a>
      <a class="btn btn-sm btn-success" href="{% url 'camisas:remessa_create' %}">+ Nova remessa</a>
      <a class="btn btn-sm btn-light" href="{% url 'camisas:costureira_list' %}">Costureiras</a>

      <!-- Página atual -->
      <a class="btn btn-sm btn-primary" href="{% url 'camisas:pagamentos_list' %}">Relatórios</a>

      <a class="btn btn-sm btn-warning" href="{% url 'camisas:op_create' %}">Ordem Produção</a>
      <a class="btn btn-sm btn-info" href="{% url 'camisas:pedido_list' %}">Pedidos</a>
    </div>
  </div>
</nav>

<main class="container py-4">

  {% for message in messages %}<div class="alert alert-{{ message.tags }}">{{ message }}</div>{% endfor %}

  <!-- Header local -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h5 m-0">Relatórios • Pagamentos a Costureiras</h1>
      <div class="mini">Filtre por empresa, costureira, tipo, status e período. Exporte o resultado.</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'camisas:home' %}">Voltar ao início</a>
    </div>
  </div>

  <!-- Toolbar / Filtros (igual ao home) -->
  <div class="bg-white border rounded-3 p-3 toolbar mb-3">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-12 col-lg-3">
        <label class="form-label mini">Empresa</label>
        {{ form.empresa }}
      </div>
      <div class="col-12 col-lg-3">
        <label class="form-label mini">Costureira</label>
        {{ form.costureira }}
      </div>
      <div class="col-6 col-lg-2">
        <label class="form-label mini">Tipo</label>
        {{ form.tipo }}
      </div>
      <div class="col-6 col-lg-2">
        <label class="form-label mini">Status</label>
        {{ form.status }}
      </div>
      <div class="col-6 col-lg-1">
        <label class="form-label mini">De</label>
        {{ form.data_de }}
      </div>
      <div class="col-6 col-lg-1">
        <label class="form-label mini">Até</label>
        {{ form.data_ate }}
      </div>
      <div class="col-6 col-lg-2 d-grid">
        <button class="btn btn-primary">Filtrar</button>
      </div>
      <div class="col-6 col-lg-2 d-grid">
        <a class="btn btn-outline-secondary" href="{% url 'camisas:pagamentos_list' %}">Limpar</a>
      </div>
      <div class="col-12 col-lg-3 d-grid ms-auto">
        <a class="btn btn-dark" href="{% url 'camisas:pagamentos_export_csv' %}?{{ request.GET.urlencode }}">Exportar CSV (servidor)</a>
      </div>
    </form>
  </div>

  <!-- KPIs iguais ao home -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-lg-3">
      <div class="kpi">
        <div class="label">Total pendente</div>
        <div class="value">R$ {{ kpi.total_pendente|floatformat:2 }}</div>
        <div class="mini">Qtd pendente: {{ kpi.qtd_pendente }}</div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="kpi">
        <div class="label">Total pago</div>
        <div class="value">R$ {{ kpi.total_pago|floatformat:2 }}</div>
        <div class="mini">Qtd pago: {{ kpi.qtd_pago }}</div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="kpi">
        <div class="label">Período</div>
        <div class="mini">
          {% if form.data_de.value %}de {{ form.data_de.value }}{% else %}sem início{% endif %}
          {% if form.data_ate.value %} até {{ form.data_ate.value }}{% else %} • sem fim{% endif %}
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="kpi">
        <div class="label">Filtros</div>
        <div class="mini">Status: {{ form.status.value|default:"Todos" }}</div>
        <div class="mini">Tipo: {{ form.tipo.value|default:"Todos" }}</div>
      </div>
    </div>
  </div>

  <!-- Tabela dentro de card, como no home -->
  <div class="card-clean p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0">Pagamentos</h2>
      <button id="btnExportTabela" class="btn btn-dark btn-sm">Exportar CSV (tela)</button>
    </div>

    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead>
          <tr>
            <th>#</th><th>Empresa</th><th>Costureira</th><th>Remessa</th><th>Tipo</th>
            <th>Valor</th><th>Status</th><th>Criado</th><th>Pago em</th><th class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody id="tblBodyPays">
          {% for p in rows %}
          <tr>
            <td class="mini">{{ p.id }}</td>
            <td>{{ p.empresa.nome_fantasia }}</td>
            <td>{{ p.costureira.nome }}</td>
            <td><a href="{% url 'camisas:remessa_detail' p.remessa.id %}">{{ p.remessa.numero }}</a></td>
            <td>{{ p.remessa.get_tipo_display }}</td>
            <td class="fw-semibold">R$ {{ p.valor_total|floatformat:2 }}</td>
            <td>
              <span class="badge {% if p.status == 'PAGO' %}text-bg-success{% else %}text-bg-warning{% endif %}">{{ p.get_status_display }}</span>
            </td>
            <td class="mini">{{ p.criado_em|date:"d/m/Y H:i" }}</td>
            <td class="mini">{% if p.pago_em %}{{ p.pago_em|date:"d/m/Y H:i" }}{% else %}—{% endif %}</td>
            <td class="text-end">
              {% if p.status == 'PENDENTE' %}
                <a class="btn btn-sm btn-outline-success" href="{% url 'camisas:pagamento_marcar_pago' p.id %}">Marcar pago</a>
              {% else %}
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'camisas:pagamento_marcar_pendente' p.id %}">Voltar p/ pendente</a>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="10" class="text-center text-muted py-4">Nenhum pagamento encontrado.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if page_obj %}
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="mini">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</div>
        <nav>
          <ul class="pagination pagination-sm mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}">Anterior</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Anterior</span></li>
            {% endif %}
            <li class="page-item active"><span class="page-link">{{ page_obj.number }}</span></li>
            {% if page_obj.has_next %}
              <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}">Próxima</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Próxima</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}
  </div>
</main>

<script>
(function(){
  const btn = document.getElementById('btnExportTabela');
  btn && btn.addEventListener('click', ()=>{
    const body = document.getElementById('tblBodyPays');
    if(!body){ alert('Sem dados'); return; }
    const rows = Array.from(body.querySelectorAll('tr'));
    if(!rows.length){ alert('Sem dados'); return; }

    const head = ['ID','Empresa','Costureira','Remessa','Tipo','Valor','Status','Criado','Pago_em'];
    const data = rows.map(r=>{
      const t = Array.from(r.children);
      return [
        t[0]?.innerText || '',
        t[1]?.innerText || '',
        t[2]?.innerText || '',
        (t[3]?.innerText || '').trim(),
        t[4]?.innerText || '',
        (t[5]?.innerText || '').replace('R$','').trim(),
        (t[6]?.innerText || '').trim(),
        t[7]?.innerText || '',
        t[8]?.innerText || ''
      ];
    });

    const csv = [head, ...data].map(row=> row.map(c=> `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='pagamentos_costureiras.csv';
    document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 1200);
  });
})();
</script>

</body>
</html>
