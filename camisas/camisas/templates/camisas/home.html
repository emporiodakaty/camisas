<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Camisas ‚Ä¢ In√≠cio (Dashboard)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <style>
    :root{ --ink:#2a0f1a; --muted:#64748b; --ring:rgba(37,99,235,.18); --g1:#f30c80; --g2:#f30c80; --base-font:14px; }
    html{ font-size:var(--base-font); } body{ background:#f6f8fb; color:var(--ink); }
    .nav-pro{ background:linear-gradient(90deg,var(--g1),var(--g2)); }
    .kpi{ background:#fff; border:1px solid #e5e7eb; border-radius:.9rem; padding:.9rem 1.1rem; }
    .kpi .label{ color:var(--muted); font-size:.78rem; text-transform:uppercase; letter-spacing:.04em; }
    .kpi .value{ font-weight:800; font-size:1.25rem; }
    .card-clean{ border:none; border-radius:.9rem; box-shadow:0 10px 24px rgba(17,24,39,.08); }
    .toolbar .form-control, .toolbar .form-select{ border-radius:.65rem; }
    .toolbar .form-control:focus, .toolbar .form-select:focus{ box-shadow:0 0 0 .25rem var(--ring); border-color:#93c5fd; }
    .table{ font-size:.875rem; }
    .table thead th{ font-size:.78rem; text-transform:uppercase; letter-spacing:.04em; color:#64748b; border-top:0; }
    .empty{ border:1px dashed #cbd5e1; border-radius:12px; background:#fff; padding:2rem; text-align:center; color:var(--muted); }
    .mini{ font-size:.8rem; color:var(--muted); }
    .badge-soft{ background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }
    .btn-sm{ font-size:.82rem; }
    .chart-card{ padding:1rem; }
    .shortcut a{ text-decoration:none; color:inherit; }
    .shortcut .icon{ font-size:2rem; line-height:1; }
    .footer-credit{ text-align:center; padding:16px 0; color:#64748b; font-size:.85rem; }
  </style>
</head>
<body>

<nav class="navbar nav-pro navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{% url 'camisas:home' %}">EMP√ìRIO DA KATY</a>

    <div class="ms-auto d-flex align-items-center gap-2">
      {% url 'logout' as logout_url %}
      {% if not logout_url %}{% url 'camisas:logout' as logout_url %}{% endif %}
      {% if logout_url %}
        <form action="{{ logout_url }}" method="post" class="d-inline m-0">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-outline-light">Sair</button>
        </form>
      {% endif %}
    </div>
  </div>
</nav>

<main class="container py-4">

  {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
  {% endfor %}

  {# URLs auxiliares #}
  {% url 'camisas:pedido_create' as pedido_create_url %}
  {% if not pedido_create_url %}{% url 'camisas:pedido_novo'  as pedido_create_url %}{% endif %}
  {% if not pedido_create_url %}{% url 'camisas:pedido_form'  as pedido_create_url %}{% endif %}
  {% url 'camisas:pedidos_home' as pedidos_home_url %}
  {% url 'camisas:pedido_list'  as pedido_list_url %}
  {% url 'camisas:freq_resumo'  as freq_resumo_url %}

  <!-- Atalhos dos m√≥dulos -->
  <div class="row g-3 mb-3 shortcut">
    <div class="col-12 col-md-3">
      <a href="{% url 'camisas:pedidos_home' %}">
        <div class="card-clean p-3 d-flex align-items-center gap-3 h-100">
          <div class="icon">üßæ</div>
          <div>
            <div class="h6 m-0">Pedidos</div>
            <div class="mini">Vendas, status, top produtos</div>
          </div>
        </div>
      </a>
    </div>

    <!-- Or√ßamento -->
    <div class="col-12 col-md-3">
      <a href="{{ pedido_create_url|default:pedidos_home_url|default:pedido_list_url }}">
        <div class="card-clean p-3 d-flex align-items-center gap-3 h-100">
          <div class="icon">üìù</div>
          <div>
            <div class="h6 m-0">Or√ßamento</div>
            <div class="mini">Criar novo pedido/or√ßamento</div>
          </div>
        </div>
      </a>
    </div>

    <!-- Frequ√™ncia -->
    <div class="col-12 col-md-3">
      <a href="{{ freq_resumo_url|default:'#' }}">
        <div class="card-clean p-3 d-flex align-items-center gap-3 h-100">
          <div class="icon">‚è∞</div>
          <div>
            <div class="h6 m-0">Frequ√™ncia</div>
            <div class="mini">Lan√ßamentos e resumo mensal</div>
          </div>
        </div>
      </a>
    </div>

    <div class="col-12 col-md-3">
      <a href="{% url 'camisas:despesas_home' %}">
        <div class="card-clean p-3 d-flex align-items-center gap-3 h-100">
          <div class="icon">üí∏</div>
          <div>
            <div class="h6 m-0">Despesas</div>
            <div class="mini">Totais, categorias, vencimentos</div>
          </div>
        </div>
      </a>
    </div>

    <div class="col-12 col-md-3">
      <a href="{% url 'camisas:costureiras_home' %}">
        <div class="card-clean p-3 d-flex align-items-center gap-3 h-100">
          <div class="icon">üßµ</div>
          <div>
            <div class="h6 m-0">Costureiras / Produ√ß√£o</div>
            <div class="mini">Pe√ßas, remessas, OPs</div>
          </div>
        </div>
      </a>
    </div>

    <div class="col-12 col-md-3">
      <a href="{% url 'camisas:clientes_home' %}">
        <div class="card-clean p-3 d-flex align-items-center gap-3 h-100">
          <div class="icon">üë•</div>
          <div>
            <div class="h6 m-0">Clientes</div>
            <div class="mini">Base, ativos, receita</div>
          </div>
        </div>
      </a>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <!-- Receita FATURADA (somente pedidos FAT) -->
    <div class="col-6 col-lg-3">
      <div class="kpi">
        <div class="label">Receita faturada ({{ kpis.window_label }})</div>
        <div class="value">R$ {{ kpis.receita_faturado|default:kpis.receita|floatformat:2 }}</div>
        <div class="mini">Ticket m√©dio: R$ {{ kpis.ticket_medio|floatformat:2 }}</div>
      </div>
    </div>

    <!-- Valor PENDENTE (n√£o faturado, exclui cancelados) -->
    <div class="col-6 col-lg-3">
      <div class="kpi">
        <div class="label">Pendentes (R$)</div>
        <div class="value">R$ {{ kpis.receita_pendente|default:0|floatformat:2 }}</div>
        <div class="mini">Aguardando faturamento</div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="kpi">
        <div class="label">Pedidos</div>
        <div class="value">{{ kpis.qtd_pedidos }}</div>
        <div class="mini">Faturados: {{ kpis.qtd_faturados }}</div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="kpi">
        <div class="label">Produ√ß√£o (pe√ßas)</div>
        <div class="value">{{ kpis.pecas_produzidas }}</div>
        <div class="mini">OPs: {{ kpis.ops }}</div>
      </div>
    </div>
    <div class="col-6 col-lg-3">
      <div class="kpi">
        <div class="label">Clientes ativos</div>
        <div class="value">{{ kpis.clientes_ativos }}</div>
        <div class="mini">Novos: {{ kpis.clientes_novos }}</div>
      </div>
    </div>
  </div>

  <!-- Gr√°ficos -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-xl-8">
      <div class="card-clean chart-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 m-0">Vendas por dia</h2>
          <span class="mini">Per√≠odo: {{ kpis.window_label }}</span>
        </div>
        <canvas id="chartSales" height="120"></canvas>
      </div>
    </div>
    <div class="col-12 col-xl-4">
      <div class="card-clean chart-card">
        <h2 class="h6 mb-2">Mix por produto</h2>
        <canvas id="chartProducts" height="180"></canvas>
      </div>
      <div class="card-clean chart-card mt-3">
        <h2 class="h6 mb-2">Status dos pedidos</h2>
        <canvas id="chartStatus" height="140"></canvas>
      </div>
    </div>
  </div>

  <!-- Listas -->
  <div class="row g-3">
    <!-- Pedidos recentes -->
    <div class="col-12 col-xl-7">
      <div class="card-clean p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="h6 m-0">Pedidos recentes</h2>
          <button id="btnExportPedidos" class="btn btn-dark btn-sm">Exportar CSV</button>
        </div>
        {% if pedidos_recent and pedidos_recent|length %}
          <div class="table-responsive mt-2">
            <table class="table align-middle">
              <thead><tr><th>#</th><th>Cliente</th><th>Status</th><th>Total</th><th>Data</th><th></th></tr></thead>
              <tbody id="tblBodyPedidos">
                {% for p in pedidos_recent %}
                  <tr>
                    <td class="fw-semibold">#{{ p.id }}</td>
                    <td>{{ p.cliente__nome|default:p.cliente }}</td>
                    <td><span class="badge badge-soft">{{ p.status_label|default:p.status }}</span></td>
                    <td>R$ {{ p.total|floatformat:2 }}</td>
                    <td>{{ p.criado_em|date:"d/m/Y H:i" }}</td>
                    <td class="d-flex gap-1">
                      <a class="btn btn-sm btn-outline-primary" href="{% url 'camisas:pedido_detail' p.id %}">Abrir</a>
                      <a class="btn btn-sm btn-outline-dark" href="{% url 'camisas:pedido_enviar_arte' p.id %}">Arte</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="empty mt-2">Sem pedidos neste per√≠odo.</div>
        {% endif %}
      </div>
    </div>

    <!-- Baixo estoque / Produ√ß√£o -->
    <div class="col-12 col-xl-5">
      <div class="card-clean p-3 mb-3"> 
        <h2 class="h6 mb-2">Avisos de estoque</h2>
        {% if baixo_estoque and baixo_estoque|length %}
          <ul class="list-group list-group-flush">
            {% for v in baixo_estoque %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ v.produto__nome }} <span class="mini">({{ v.tamanho }}/{{ v.cor }})</span></span>
                <span class="badge text-bg-danger">{{ v.estoque_atual }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="empty">Tudo ok! Nenhum item com estoque baixo.</div>
        {% endif %}
      </div>

      <div class="card-clean p-3">
        <h2 class="h6 mb-2">Produ√ß√£o recente</h2>
        {% if ops_recent and ops_recent|length %}
          <div class="table-responsive">
            <table class="table align-middle">
              <thead><tr><th>OP</th><th>Varia√ß√£o</th><th>Qtd</th><th>Data</th></tr></thead>
              <tbody>
                {% for op in ops_recent %}
                  <tr>
                    <td>#{{ op.id }}</td>
                    <td>{{ op.variacao__produto__nome }} {{ op.variacao__tamanho }}/{{ op.variacao__cor }}</td>
                    <td>{{ op.quantidade }}</td>
                    <td>{{ op.criado_em|date:"d/m/Y H:i" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="empty">Nenhuma OP processada no per√≠odo.</div>
        {% endif %}
      </div>
    </div>
  </div>
</main>

<div class="footer-credit">
  Desenvolvido por Alexandre Martins Vieira 2025
</div>

<!-- DASH data (JSON pr√©-serializado vindo da view) -->
<script>
  const DASH = {{ dash|safe }};
</script>

<script>
(function(){
  // Export CSV
  const btnCsv = document.getElementById('btnExportPedidos');
  btnCsv && btnCsv.addEventListener('click', ()=>{
    const body = document.getElementById('tblBodyPedidos');
    if(!body){ alert('Sem dados'); return; }
    const rows = Array.from(body.querySelectorAll('tr'));
    if(!rows.length){ alert('Sem dados'); return; }
    const head = ['ID','Cliente','Status','Total','Data'];
    const data = rows.map(r=>{
      const tds = Array.from(r.children);
      return [tds[0].innerText.replace('#',''), tds[1].innerText, tds[2].innerText, tds[3].innerText, tds[4].innerText];
    });
    const csv = [head, ...data].map(row=> row.map(c=> `"${(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='pedidos_recentes.csv';
    document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 1200);
  });

  // Helpers Chart
  function safeArr(a){ return Array.isArray(a) ? a : []; }
  function asCurrency(v){ return (v||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }

  // Vendas por dia
  const elSales = document.getElementById('chartSales');
  if (elSales && DASH?.sales){
    new Chart(elSales, {
      type: 'line',
      data: { labels: safeArr(DASH.sales.labels),
              datasets: [{ label: 'Receita', data: safeArr(DASH.sales.values), tension:.25, fill:true }] },
      options: {
        responsive:true, interaction:{ mode:'index', intersect:false },
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(c)=>asCurrency(c.parsed.y) } } },
        scales:{ y:{ ticks:{ callback:(v)=>asCurrency(v) } } }
      }
    });
  }

  // Mix por produto
  const elProd = document.getElementById('chartProducts');
  if (elProd && DASH?.top_products){
    new Chart(elProd, {
      type:'bar',
      data:{ labels: safeArr(DASH.top_products.labels), datasets:[{ label:'Receita', data: safeArr(DASH.top_products.values) }] },
      options:{ indexAxis:'y', plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(c)=>asCurrency(c.parsed.x) } } },
                scales:{ x:{ ticks:{ callback:(v)=>asCurrency(v) } } } }
    });
  }

  // Status dos pedidos
  const elStatus = document.getElementById('chartStatus');
  if (elStatus && DASH?.status_breakdown){
    new Chart(elStatus, {
      type:'doughnut',
      data:{ labels: safeArr(DASH.status_breakdown.labels), datasets:[{ data: safeArr(DASH.status_breakdown.values) }] },
      options:{ plugins:{ legend:{ position:'bottom' } }, cutout:'60%' }
    });
  }
})();
</script>

</body>
</html>
